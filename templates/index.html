<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIRA-Lark 同步系統 - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        /* Light Mode Styles */
        body.light-mode {
            background: linear-gradient(135deg, #fefefe 0%, #f8f8f0 100%);
            color: #2d2d2d;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 0;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        body.light-mode .sidebar {
            background: rgba(255, 255, 255, 0.8);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.light-mode .sidebar-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .sidebar-info {
            flex: 1;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4fc3f7;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #888888;
        }

        body.light-mode .sidebar-subtitle {
            color: #666666;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            width: 40px;
            height: 24px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 2px;
        }

        body.light-mode .theme-toggle {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .theme-toggle-slider {
            width: 18px;
            height: 18px;
            background: #4fc3f7;
            border-radius: 50%;
            transition: transform 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.light-mode .theme-toggle-slider {
            transform: translateX(16px);
            background: #ffc107;
        }

        .theme-icon {
            width: 10px;
            height: 10px;
            fill: #ffffff;
        }

        .sidebar-nav {
            padding: 0 10px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 0 15px 12px;
            font-size: 13px;
            font-weight: 600;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 2px 0;
            border-radius: 8px;
            color: #cccccc;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        body.light-mode .nav-item {
            color: #666666;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }

        body.light-mode .nav-item:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333333;
        }

        .nav-item.active {
            background: rgba(79, 195, 247, 0.15);
            color: #4fc3f7;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }

        .nav-item .nav-icon {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .nav-item .nav-text {
            flex: 1;
        }

        .nav-item .nav-arrow {
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .nav-item.expanded .nav-arrow {
            transform: rotate(90deg);
        }

        /* Team Submenu */
        .team-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-left: 30px;
            margin-top: 5px;
        }

        .team-submenu.expanded {
            max-height: 200px;
        }

        .submenu-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            margin: 1px 0;
            border-radius: 6px;
            color: #999999;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: #cccccc;
        }

        .submenu-item.active {
            background: rgba(79, 195, 247, 0.1);
            color: #4fc3f7;
        }

        .submenu-item .submenu-icon {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666666;
            margin-right: 10px;
        }

        .submenu-item.active .submenu-icon {
            background: #4fc3f7;
        }

        .team-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: auto;
        }

        .team-status.running {
            background: #66bb6a;
            animation: pulse 2s infinite;
        }

        .team-status.paused {
            background: #ffc107;
        }

        .team-status.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* System Status Section */
        .system-status-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        body.light-mode .system-status-section,
        body.light-mode .quick-actions {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        body.light-mode .status-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        body.light-mode .status-label {
            color: #555555;
        }

        body.light-mode .status-value {
            color: #1a1a1a;
        }

        body.light-mode .status-title,
        body.light-mode .actions-title {
            color: #1976d2;
        }

        .status-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: #4fc3f7;
            text-align: left;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .status-card:hover {
            transform: translateY(-2px);
        }

        .status-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(102, 187, 106, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #66bb6a;
            animation: pulse 2s infinite;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .status-label {
            font-size: 12px;
            color: #cccccc;
        }

        /* Quick Actions */
        .quick-actions {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .actions-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: #4fc3f7;
            text-align: left;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: rgba(79, 195, 247, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(79, 195, 247, 0.2);
            border-radius: 6px;
            color: #4fc3f7;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 90px;
            width: 90px;
            box-sizing: border-box;
        }

        body.light-mode .action-btn {
            background: rgba(79, 195, 247, 0.08);
            border: 1px solid rgba(79, 195, 247, 0.3);
            color: #1976d2;
        }

        body.light-mode .action-btn:hover {
            background: rgba(79, 195, 247, 0.15);
            box-shadow: 0 4px 16px rgba(79, 195, 247, 0.25);
        }

        .action-btn:hover {
            background: rgba(79, 195, 247, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(79, 195, 247, 0.3);
        }

        .action-btn.primary {
            background: rgba(79, 195, 247, 0.8);
            color: #000000;
        }

        .action-btn.primary:hover {
            background: rgba(79, 195, 247, 1);
            box-shadow: 0 4px 16px rgba(79, 195, 247, 0.4);
        }

        body.light-mode .action-btn.primary {
            background: rgba(79, 195, 247, 0.9);
            color: #ffffff;
        }

        body.light-mode .action-btn.primary:hover {
            background: rgba(79, 195, 247, 1);
            box-shadow: 0 4px 16px rgba(79, 195, 247, 0.4);
        }

        .action-btn.warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .action-btn.warning:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3);
        }

        body.light-mode .action-btn.warning {
            background: rgba(255, 193, 7, 0.08);
            border-color: rgba(255, 193, 7, 0.3);
            color: #f57c00;
        }

        body.light-mode .action-btn.warning:hover {
            background: rgba(255, 193, 7, 0.15);
            box-shadow: 0 4px 16px rgba(255, 193, 7, 0.25);
        }

        .action-btn.success {
            background: rgba(102, 187, 106, 0.1);
            border-color: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        .action-btn.success:hover {
            background: rgba(102, 187, 106, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(102, 187, 106, 0.3);
        }

        body.light-mode .action-btn.success {
            background: rgba(102, 187, 106, 0.08);
            border-color: rgba(102, 187, 106, 0.3);
            color: #388e3c;
        }

        body.light-mode .action-btn.success:hover {
            background: rgba(102, 187, 106, 0.15);
            box-shadow: 0 4px 16px rgba(102, 187, 106, 0.25);
        }


        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                top: 0;
                left: -100%;
                z-index: 1000;
                height: 100vh;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .system-status {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
            }
        }

        /* Modal Overlay and Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            animation: fadeIn 0.2s ease forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .modal {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            min-width: 400px;
            max-width: 500px;
            color: #ffffff;
            transform: scale(0.8);
            animation: modalSlideIn 0.2s ease forwards;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        body.light-mode .modal {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d2d2d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        @keyframes modalSlideIn {
            to {
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4fc3f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: #ffffff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        body.light-mode .modal-close {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #2d2d2d;
        }
        
        body.light-mode .modal-close:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        body.light-mode .modal-title {
            color: #0288d1;
        }

        .modal-content {
            margin: 20px 0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .modal-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        body.light-mode .modal-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d2d2d;
        }

        .modal-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        body.light-mode .modal-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .modal-btn.primary {
            background: rgba(79, 195, 247, 0.8);
            color: #000000;
            border: 1px solid rgba(79, 195, 247, 0.5);
        }

        .modal-btn.primary:hover {
            background: rgba(79, 195, 247, 1);
            box-shadow: 0 4px 16px rgba(79, 195, 247, 0.4);
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.light-mode .modal-btn.secondary {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        /* Content Sections */
        .content-section {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .content-section.active {
            display: block;
        }

        /* Table Settings Styles */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #888888;
        }

        body.light-mode .breadcrumb {
            color: #666666;
        }

        .breadcrumb a {
            color: #4fc3f7;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .breadcrumb a:hover {
            color: #81d4fa;
        }

        .breadcrumb-separator {
            color: #666666;
        }

        .page-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.light-mode .page-header {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .table-icon, .page-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #4fc3f7;
        }

        body.light-mode .table-icon, body.light-mode .page-icon {
            background: rgba(0, 0, 0, 0.1);
        }

        .header-details h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
        }

        body.light-mode .header-details h1 {
            color: #2d2d2d;
        }

        .header-meta {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        body.light-mode .header-meta {
            color: #666666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.875rem;
            color: #888888;
        }

        body.light-mode .meta-item {
            color: #666666;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #66bb6a;
            font-size: 0.875rem;
        }

        .master-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 3px;
            transition: all 0.3s ease;
        }

        .master-toggle.active {
            background: rgba(79, 195, 247, 0.3);
            border-color: rgba(79, 195, 247, 0.5);
        }

        .master-toggle-slider {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #4fc3f7;
        }

        .master-toggle.active .master-toggle-slider {
            transform: translateX(28px);
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        body.light-mode .settings-section {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .settings-section h3 {
            margin: 0 0 20px 0;
            color: #4fc3f7;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ffffff;
        }

        body.light-mode .form-group label {
            color: #2d2d2d;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        body.light-mode .form-group input, 
        body.light-mode .form-group select, 
        body.light-mode .form-group textarea {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #2d2d2d;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }


        .toggle-label {
            margin-left: 10px;
            vertical-align: middle;
            color: #ffffff;
        }

        body.light-mode .toggle-label {
            color: #2d2d2d;
        }

        /* Toggle Switch for Settings */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        body.light-mode .toggle-switch {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active {
            background: rgba(79, 195, 247, 0.3);
            border-color: rgba(79, 195, 247, 0.5);
        }

        .toggle-slider {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        body.light-mode .toggle-slider {
            background: rgba(0, 0, 0, 0.6);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
            background: #4fc3f7;
        }

        body.light-mode .toggle-switch.active .toggle-slider {
            background: #0288d1;
        }

        /* Additional Table Settings Styles */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .settings-section.full-width {
            grid-column: 1 / -1;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4fc3f7;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.light-mode .section-title {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .toggle-row {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ffffff;
            font-size: 14px;
        }

        body.light-mode .setting-label {
            color: #2d2d2d;
        }

        .setting-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        body.light-mode .setting-input {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #2d2d2d;
        }

        .setting-input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }

        .jql-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
        }

        .setting-help {
            font-size: 12px;
            color: #888888;
            margin-top: 5px;
        }

        body.light-mode .setting-help {
            color: #666666;
        }

        .jql-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .jql-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        body.light-mode .jql-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d2d2d;
        }

        .jql-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        body.light-mode .jql-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .jql-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .jql-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            min-height: 20px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .result-success {
            color: #66bb6a;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .result-error {
            color: #f44336;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .jql-success {
            color: #66bb6a;
            background: rgba(102, 187, 106, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #66bb6a;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .jql-error {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #f44336;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .jql-info {
            color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #4fc3f7;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Query Results Table */
        .query-results {
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        body.light-mode .query-results {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .results-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.light-mode .results-header {
            background: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .results-header h4 {
            margin: 0;
            color: #4fc3f7;
            font-size: 1rem;
        }

        .results-count {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .results-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.light-mode .results-table th,
        body.light-mode .results-table td {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .results-table th {
            background: rgba(255, 255, 255, 0.03);
            font-weight: 600;
            color: #4fc3f7;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.light-mode .results-table th {
            background: rgba(0, 0, 0, 0.02);
        }

        .results-table td {
            color: #ffffff;
            font-size: 14px;
        }

        body.light-mode .results-table td {
            color: #2d2d2d;
        }

        .results-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        body.light-mode .results-table tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .results-table a {
            color: #4fc3f7;
            text-decoration: none;
            font-weight: 500;
        }

        .results-table a:hover {
            color: #81d4fa;
            text-decoration: underline;
        }

        /* Team Settings Styles */
        .team-nav-item .nav-text {
            cursor: pointer;
            flex: 1;
        }

        .team-nav-item .nav-text:hover {
            color: #4fc3f7;
        }

        .team-nav-item .nav-arrow {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .team-nav-item .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        body.light-mode .team-nav-item .nav-arrow:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .table-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        body.light-mode .table-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .table-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(79, 195, 247, 0.3);
        }

        body.light-mode .table-item:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(79, 195, 247, 0.5);
        }

        .table-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .table-item-title {
            font-weight: 600;
            color: #4fc3f7;
            font-size: 1rem;
        }

        .table-item-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .table-item-status.enabled {
            color: #66bb6a;
        }

        .table-item-status.disabled {
            color: #f44336;
        }

        .table-item-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 13px;
            color: #cccccc;
        }

        body.light-mode .table-item-info {
            color: #666666;
        }

        .table-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .table-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #ffffff;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        body.light-mode .table-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d2d2d;
        }

        .table-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        body.light-mode .table-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .table-btn.primary {
            background: rgba(79, 195, 247, 0.8);
            border-color: rgba(79, 195, 247, 0.5);
            color: #000000;
        }

        .table-btn.primary:hover {
            background: rgba(79, 195, 247, 1);
        }

        .full-width {
            width: 100%;
            margin-top: 16px;
        }

        .result-loading {
            color: #4fc3f7;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .query-results {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        body.light-mode .query-results {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .results-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.light-mode .results-header {
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .results-header h4 {
            margin: 0;
            color: #4fc3f7;
            font-size: 16px;
        }

        .results-count {
            color: #888888;
            font-size: 14px;
        }

        body.light-mode .results-count {
            color: #666666;
        }

        .results-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.light-mode .results-table th,
        body.light-mode .results-table td {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .results-table th {
            background: rgba(255, 255, 255, 0.03);
            color: #888888;
            font-weight: 500;
            font-size: 13px;
            position: sticky;
            top: 0;
        }

        body.light-mode .results-table th {
            background: rgba(255, 255, 255, 0.9);
            color: #666666;
        }

        .issue-key {
            color: #4fc3f7;
            font-weight: 500;
        }

        .issue-title {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.open {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
        }

        .status-badge.in-progress {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-badge.closed {
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        .priority-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-badge.high {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .priority-badge.medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .priority-badge.low {
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        /* Field Mapping Styles */
        .mapping-section {
            margin-bottom: 30px;
        }

        .mapping-section h4 {
            margin: 0 0 15px 0;
            color: #ffffff;
            font-size: 16px;
        }

        body.light-mode .mapping-section h4 {
            color: #2d2d2d;
        }

        .mapping-container {
            margin-bottom: 15px;
        }

        .mapping-item {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .mapping-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .mapping-options {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            padding-left: 10px;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }

        body.light-mode .mapping-item {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mapping-item input, .mapping-item select {
            flex: 1;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 6px 8px;
            color: #ffffff;
            font-size: 13px;
        }
        
        .mapping-item select {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .mapping-item select option {
            background: #2d2d2d;
            color: #ffffff;
        }

        body.light-mode .mapping-item input, body.light-mode .mapping-item select {
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d2d2d;
        }
        
        body.light-mode .mapping-item select {
            background: rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .mapping-item select option {
            background: #ffffff;
            color: #2d2d2d;
        }

        .mapping-arrow {
            color: #888888;
            font-size: 12px;
        }

        .mapping-remove {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mapping-remove:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        /* Smart Field Wizard Styles */
        .wizard-step {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        body.light-mode .wizard-step {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .wizard-step h5 {
            color: #4fc3f7;
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        body.light-mode .wizard-step h5 {
            color: #0288d1;
        }
        
        .wizard-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            position: relative;
            overflow-x: auto;
        }
        
        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }
        
        .progress-step {
            background: #666666;
            border: 2px solid #666666;
            border-radius: 25px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 500;
            color: #ffffff;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 80px;
            text-align: center;
        }
        
        .progress-step.active {
            background: #4fc3f7;
            border-color: #4fc3f7;
            color: #ffffff;
        }
        
        .progress-step.completed {
            background: #66bb6a;
            border-color: #66bb6a;
            color: #ffffff;
        }
        
        body.light-mode .wizard-progress::before {
            background: rgba(0, 0, 0, 0.1);
            z-index: 0;
        }
        
        body.light-mode .progress-step {
            background: #999999;
            border: 2px solid #999999;
            color: #ffffff;
        }
        
        body.light-mode .progress-step.active {
            background: #0288d1;
            border-color: #0288d1;
            color: #ffffff;
        }
        
        body.light-mode .progress-step.completed {
            background: #43a047;
            border-color: #43a047;
            color: #ffffff;
        }
        
        .info-display {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 15px;
            color: #ffffff;
        }
        
        body.light-mode .info-display {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #2d2d2d;
        }
        
        .fields-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
        }
        
        body.light-mode .fields-list {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .field-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .field-item:last-child {
            border-bottom: none;
        }
        
        .field-item:hover {
            background: rgba(79, 195, 247, 0.1);
        }
        
        .field-item.selected {
            background: rgba(79, 195, 247, 0.2);
            border-left: 3px solid #4fc3f7;
        }
        
        body.light-mode .field-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .field-item:hover {
            background: rgba(2, 136, 209, 0.05);
        }
        
        body.light-mode .field-item.selected {
            background: rgba(2, 136, 209, 0.1);
            border-left: 3px solid #0288d1;
        }
        
        .field-path {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            color: #4fc3f7;
            font-weight: 500;
        }
        
        body.light-mode .field-path {
            color: #0288d1;
        }
        
        .field-type {
            font-size: 11px;
            color: #888888;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        body.light-mode .field-type {
            background: rgba(0, 0, 0, 0.1);
            color: #666666;
        }
        
        .check-result {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .check-result.success {
            background: rgba(102, 187, 106, 0.1);
            border: 1px solid rgba(102, 187, 106, 0.3);
            color: #66bb6a;
        }
        
        .check-result.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }
        
        body.light-mode .check-result.success {
            background: rgba(67, 160, 71, 0.05);
            border: 1px solid rgba(67, 160, 71, 0.2);
            color: #43a047;
        }
        
        body.light-mode .check-result.warning {
            background: rgba(255, 152, 0, 0.05);
            border: 1px solid rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }
        
        .review-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
        }
        
        body.light-mode .review-content {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        body.light-mode .review-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .review-label {
            font-weight: 500;
            color: #ffffff;
        }
        
        .review-value {
            color: #4fc3f7;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
        }
        
        body.light-mode .review-label {
            color: #2d2d2d;
        }
        
        body.light-mode .review-value {
            color: #0288d1;
        }

        
        /* Button Styles */
        .btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        body.light-mode .btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #2d2d2d;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        body.light-mode .btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn.success {
            background: rgba(102, 187, 106, 0.1);
            border: 1px solid rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        .btn.success:hover {
            background: rgba(102, 187, 106, 0.2);
            box-shadow: 0 4px 16px rgba(102, 187, 106, 0.3);
        }

        .btn.danger {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .btn.danger:hover {
            background: rgba(244, 67, 54, 0.2);
            box-shadow: 0 4px 16px rgba(244, 67, 54, 0.3);
        }

        .btn.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .btn.warning:hover {
            background: rgba(255, 193, 7, 0.2);
            box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3);
        }

        /* Action Bar */
        .action-bar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        body.light-mode .action-bar {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .action-group {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-info">
                    <div class="sidebar-title">JIRA-Lark 同步</div>
                    <div class="sidebar-subtitle">管理控制台</div>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-toggle-slider">
                        <svg class="theme-icon" viewBox="0 0 24 24">
                            <path id="theme-icon-path" d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.4 6.35,17.41C9.37,20.43 14,20.54 17.33,17.97Z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <!-- 主要導航 -->
                <div class="nav-section">
                    <div class="nav-section-title">主要功能</div>
                    
                    <a href="#" class="nav-item active" onclick="showContent('dashboard'); return false;">
                        <div class="nav-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                            </svg>
                        </div>
                        <div class="nav-text">首頁</div>
                    </a>
                </div>

                <!-- 團隊管理 -->
                <div class="nav-section" id="teams-section">
                    <div class="nav-section-title">團隊管理</div>
                    <!-- 動態生成的團隊選單將插入這裡 -->
                </div>

                <!-- 快速工具 -->
                <div class="nav-section">
                    <div class="nav-section-title">快速工具</div>
                    
                    <a href="#" class="nav-item" onclick="openTableCreator(event)">
                        <div class="nav-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                            </svg>
                        </div>
                        <div class="nav-text">快速建立資料表</div>
                    </a>
                </div>

                <!-- 系統功能 -->
                <div class="nav-section">
                    <div class="nav-section-title">系統功能</div>
                    
                    <a href="#" class="nav-item" onclick="showContent('system-settings'); return false;">
                        <div class="nav-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                            </svg>
                        </div>
                        <div class="nav-text">系統設定</div>
                    </a>

                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Content -->
            <div id="dashboard-content" class="content-section active">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h2 class="actions-title">快速操作</h2>
                    <div class="action-buttons">
                        <button class="action-btn primary" style="width: 110px;">開始所有同步</button>
                        <button class="action-btn warning" style="width: 110px;">暫停所有同步</button>
                        <button class="action-btn success" style="width: 90px;">全量更新</button>
                        <button class="action-btn" style="width: 90px;">查看日誌</button>
                    </div>
                </div>

            <!-- System Status -->
            <div class="system-status-section">
                <h2 class="status-title">系統狀態</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <div class="status-icon">
                            <div class="status-dot"></div>
                        </div>
                        <div class="status-value">執行中</div>
                        <div class="status-label">系統狀態</div>
                    </div>

                    <div class="status-card">
                        <div class="status-icon" style="background: rgba(79, 195, 247, 0.2);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#4fc3f7">
                                <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H16c-.8 0-1.54.37-2.01 1l-2.2 2.94L9 10.5v-1h2c1.1 0 2-.9 2-2s-.9-2-2-2H8c-1.1 0-2 .9-2 2s.9 2 2 2h1v1l-2.8 1.86L4 11.86v2.83L6.2 16c.8.53 1.8.8 2.8.8H12l3.55 4.28A1 1 0 0 0 16.34 22H20v-6z"/>
                            </svg>
                        </div>
                        <div class="status-value">3/6 個團隊</div>
                        <div class="status-label">活躍任務</div>
                    </div>

                    <div class="status-card">
                        <div class="status-icon" style="background: rgba(255, 193, 7, 0.2);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#ffc107">
                                <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                            </svg>
                        </div>
                        <div class="status-value">2天 14小時</div>
                        <div class="status-label">系統運行</div>
                    </div>
                </div>
            </div>

            </div>

            <!-- Table Settings Content -->
            <div id="table-settings-content" class="content-section">
                <div class="container">
                    <!-- Breadcrumb -->
                    <nav class="breadcrumb">
                        <a href="#" onclick="showContent('dashboard')">首頁</a>
                        <span class="breadcrumb-separator">></span>
                        <a href="#" onclick="showTeam()">Management</a>
                        <span class="breadcrumb-separator">></span>
                        <span id="current-table-name">TP Backlog</span>
                    </nav>

                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-info">
                            <div class="table-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                            </div>
                            <div class="header-details">
                                <h1 id="table-title">TP Backlog</h1>
                                <div class="header-meta">
                                    <span class="meta-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                        <span id="team-name">Management</span>
                                    </span>
                                    <span class="meta-item last-sync-time">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 4v6h6"/>
                                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                        </svg>
                                        2 分鐘前
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="header-controls">
                            <div class="status-indicator" id="tableStatus">
                                <span>●</span>
                                <span>執行中</span>
                            </div>
                            <div class="master-toggle active" onclick="toggleTableStatus()" id="masterToggle">
                                <div class="master-toggle-slider">✓</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="syncTable()">同步表格</button>
                            <button class="action-btn success" onclick="fullUpdateTable()">全量更新</button>
                            <button class="action-btn" onclick="saveTableSettings()">儲存設定</button>
                            <button class="action-btn" onclick="testConnection()">測試連線</button>
                        </div>
                    </div>

                    <!-- Settings Grid -->
                    <div class="settings-grid">
                        <!-- Table Settings -->
                        <div class="settings-section">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m11-7a4 4 0 0 0 0 8 4 4 0 0 0 0-8z"/>
                                </svg>
                                表格設定
                            </div>

                            <!-- Toggle Row -->
                            <div class="toggle-row">
                                <div class="toggle-item">
                                    <div class="toggle-switch" onclick="toggleSetting('dryRun')" id="dryRun">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span>Dry Run 模式</span>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">表格名稱</label>
                                <input type="text" class="setting-input" value="TP Backlog" id="tableName">
                                <div class="setting-help">顯示在系統中的表格名稱</div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label">Table ID</label>
                                <input type="text" class="setting-input" value="tblLaOEm4u2PTTk7" id="tableId">
                                <div class="setting-help">Lark Base 表格的唯一識別碼</div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label">同步間隔 (秒)</label>
                                <input type="number" class="setting-input" value="600" min="60" max="86400" id="syncInterval">
                                <div class="setting-help">自動同步的時間間隔，範圍：60-86400 秒</div>
                            </div>
                        </div>
                    </div>

                    <!-- JQL Query Section (moved to bottom) -->
                    <div class="settings-section full-width">
                        <div class="section-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            JQL 查詢設定
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">JQL 查詢語句</label>
                            <textarea class="setting-input jql-textarea" id="jqlQuery" placeholder="輸入 JQL 查詢語句...">project = TP AND issuetype in standardIssueTypes() AND ((status in (Open, "In Progress", Reopened, "In Review", "Action Needed")) OR (status = Closed AND created >= -120d) OR (status = Resolved AND updated >= -180d)) AND component in (CRM, "Game & Entertainment", "Game Integration", "Game Management", Payment, "Promotion Engine", "Shared Service", TAC, "User Management") ORDER BY updated DESC</textarea>
                            <div class="setting-help">定義要從 JIRA 同步的 Issues 查詢條件</div>
                        </div>

                        <div class="jql-actions">
                            <button class="jql-btn" onclick="validateJQL()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                                驗證語法
                            </button>
                            <button class="jql-btn secondary" onclick="testJQLQuery()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polygon points="10,8 16,12 10,16 10,8"/>
                                </svg>
                                測試查詢
                            </button>
                            <button class="jql-btn secondary" onclick="showJQLExamples()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10,9 9,9 8,9"/>
                                </svg>
                                範例
                            </button>
                            <div class="jql-result" id="jqlResult">
                                <!-- 驗證結果將顯示在這裡 -->
                            </div>
                        </div>

                        <!-- Query Results Table -->
                        <div class="query-results" id="queryResults" style="display: none;">
                            <div class="results-header">
                                <h4>查詢結果</h4>
                                <span class="results-count" id="resultsCount">0 筆記錄</span>
                            </div>
                            <div class="results-table-container">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>Issue Key</th>
                                            <th>標題</th>
                                            <th>狀態</th>
                                            <th>負責人</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody">
                                        <!-- 查詢結果將插入這裡 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Settings Content -->
            <div id="team-settings-content" class="content-section">
                <div class="container">
                    <!-- Breadcrumb -->
                    <nav class="breadcrumb">
                        <a href="#" onclick="showContent('dashboard')">首頁</a>
                        <span class="breadcrumb-separator">></span>
                        <span id="current-team-breadcrumb">ARD</span>
                        <span class="breadcrumb-separator">></span>
                        <span>團隊設定</span>
                    </nav>

                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-info">
                            <div class="team-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H16c-.8 0-1.54.37-2.01 1l-2.2 2.94L9 10.5v-1h2c1.1 0 2-.9 2-2s-.9-2-2-2H8c-1.1 0-2 .9-2 2s.9 2 2 2h1v1l-2.8 1.86L4 11.86v2.83L6.2 16c.8.53 1.8.8 2.8.8H12l3.55 4.28A1 1 0 0 0 16.34 22H20v-6z"/>
                                </svg>
                            </div>
                            <div class="header-details">
                                <h1 id="team-settings-title">ARD 設定</h1>
                                <div class="header-meta">
                                    <span class="meta-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M12 6v6l4 2"/>
                                        </svg>
                                        <span id="team-tables-count">2 個表格</span>
                                    </span>
                                    <span class="meta-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 4v6h6"/>
                                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                        </svg>
                                        <span id="team-last-sync">2 分鐘前</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="header-controls">
                            <div class="status-indicator" id="teamStatusIndicator">
                                <span>●</span>
                                <span>執行中</span>
                            </div>
                            <div class="master-toggle active" onclick="toggleTeamStatus()" id="teamMasterToggle">
                                <div class="master-toggle-slider">✓</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="syncTeam()">同步團隊</button>
                            <button class="action-btn success" onclick="fullUpdateTeam()">全量更新</button>
                            <button class="action-btn" onclick="saveTeamSettings()">儲存設定</button>
                            <button class="action-btn" onclick="testTeamConnection()">測試連線</button>
                        </div>
                    </div>

                    <!-- Settings Grid -->
                    <div class="settings-grid">
                        <!-- Team Basic Settings -->
                        <div class="settings-section">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H16c-.8 0-1.54.37-2.01 1l-2.2 2.94L9 10.5v-1h2c1.1 0 2-.9 2-2s-.9-2-2-2H8c-1.1 0-2 .9-2 2s.9 2 2 2h1v1l-2.8 1.86L4 11.86v2.83L6.2 16c.8.53 1.8.8 2.8.8H12l3.55 4.28A1 1 0 0 0 16.34 22H20v-6z"/>
                                </svg>
                                團隊基本設定
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">團隊名稱</label>
                                <input type="text" class="setting-input" value="ARD" id="teamDisplayName">
                                <div class="setting-help">顯示在系統中的團隊名稱</div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label">Wiki Token</label>
                                <input type="text" class="setting-input" value="MKdDwAgbwiVbzDkSkTHl3D8Hg0e" id="teamWikiToken">
                                <div class="setting-help">Lark Base Wiki 工作區的存取 Token</div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label">同步間隔 (秒)</label>
                                <input type="number" class="setting-input" value="300" min="60" max="86400" id="teamPollInterval">
                                <div class="setting-help">團隊同步的時間間隔，範圍：60-86400 秒</div>
                            </div>
                        </div>

                        <!-- Tables Management -->
                        <div class="settings-section">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                表格管理
                            </div>
                            
                            <div id="tables-list">
                                <!-- 表格列表將動態載入 -->
                            </div>
                            
                            <button class="action-btn secondary full-width" onclick="addNewTable()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                新增表格
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Settings Content -->
            <div id="system-settings-content" class="content-section">
                <div class="container">
                    <!-- Breadcrumb -->
                    <nav class="breadcrumb">
                        <a href="#" onclick="showContent('dashboard')">首頁</a>
                        <span class="breadcrumb-separator">></span>
                        <span>系統設定</span>
                    </nav>

                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-info">
                            <div class="page-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m10.5-3.5L7.5 7.5m0 9l4-4m0-9l4 4m-4 9l4-4"/>
                                </svg>
                            </div>
                            <div class="header-details">
                                <h1>系統設定</h1>
                                <div class="header-meta">
                                    <span class="meta-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M12 6v6l4 2"/>
                                        </svg>
                                        全域配置管理
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Grid -->
                    <div class="settings-grid">
                        <!-- Global Settings -->
                        <div class="settings-section">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="6" y2="12"/>
                                    <line x1="18" y1="12" x2="22" y2="12"/>
                                    <line x1="12" y1="6" x2="12" y2="2"/>
                                    <line x1="12" y1="22" x2="12" y2="18"/>
                                </svg>
                                全域設定
                            </div>
                            
                            <div class="toggle-row">
                                <div class="toggle-item">
                                    <div class="toggle-switch" onclick="toggleSetting('maintenanceMode')" id="maintenanceMode">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span>維護模式</span>
                                </div>
                                <div class="toggle-item">
                                    <div class="toggle-switch active" onclick="toggleSetting('autoRestart')" id="autoRestart">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span>自動重啟</span>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">輪詢間隔 (秒)</label>
                                <input type="number" class="setting-input" value="300" min="60" max="3600" id="globalPollInterval">
                                <div class="setting-help">系統全域的輪詢間隔設定</div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">日誌等級</label>
                                <select class="setting-input" id="logLevel">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR" selected>ERROR</option>
                                </select>
                                <div class="setting-help">系統日誌的詳細程度</div>
                            </div>
                        </div>

                        <!-- JIRA Settings -->
                        <div class="settings-section">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                    <polyline points="7.5,4.21 12,6.81 16.5,4.21"/>
                                    <polyline points="7.5,19.79 7.5,14.6 3,12"/>
                                    <polyline points="21,12 16.5,14.6 16.5,19.79"/>
                                </svg>
                                JIRA 連線設定
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">伺服器 URL</label>
                                <input type="text" class="setting-input" value="https://jira.tc-gaming.co/jira" id="jiraServerUrl">
                                <div class="setting-help">JIRA 伺服器的完整 URL 位址</div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">使用者名稱</label>
                                <input type="text" class="setting-input" value="jacky.h" id="jiraUsername">
                                <div class="setting-help">JIRA 登入的使用者名稱</div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">密碼</label>
                                <input type="password" class="setting-input" value="********" id="jiraPassword">
                                <div class="setting-help">JIRA 使用者密碼或 API Token</div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn success" onclick="testJiraConnectionWithFormData()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                    </svg>
                                    測試連線
                                </button>
                            </div>
                        </div>

                        <!-- Lark Base Settings -->
                        <div class="settings-section">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                Lark Base 設定
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">App ID</label>
                                <input type="text" class="setting-input" value="cli_a8d1077685be102f" id="larkAppId">
                                <div class="setting-help">Lark 應用程式的唯一識別碼</div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">App Secret</label>
                                <input type="password" class="setting-input" value="********************" id="larkAppSecret">
                                <div class="setting-help">Lark 應用程式的秘密金鑰</div>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">Base URL</label>
                                <input type="text" class="setting-input" value="https://open.larksuite.com" id="larkBaseUrl">
                                <div class="setting-help">Lark Base API 的基礎 URL</div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn success" onclick="testLarkConnectionWithFormData()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                    </svg>
                                    測試連線
                                </button>
                            </div>
                        </div>

                        <!-- Field Mappings -->
                        <div class="settings-section full-width">
                            <div class="section-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                欄位對應設定
                            </div>
                            
                            <div class="mapping-section">
                                <h4>票據欄位 <span style="color: #f44336; font-weight: bold;">必須是超連結類型</span></h4>
                                <div class="mapping-container" id="ticketFields">
                                    <div class="mapping-item">
                                        <input type="text" value="Ticket Number">
                                        <button class="mapping-remove" onclick="removeMapping(this)">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="mapping-item">
                                        <input type="text" value="TCG Tickets">
                                        <button class="mapping-remove" onclick="removeMapping(this)">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <button class="btn" onclick="addTicketField()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    新增票據欄位
                                </button>
                            </div>
                            
                            <div class="mapping-section">
                                <h4>JIRA 到 Lark 欄位對應</h4>
                                <div class="mapping-container" id="fieldMappings">
                                    <div class="mapping-item">
                                        <input type="text" value="summary">
                                        <span class="mapping-arrow">→</span>
                                        <input type="text" value="Title">
                                        <button class="mapping-remove" onclick="removeMapping(this)">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="mapping-item">
                                        <input type="text" value="status.name">
                                        <span class="mapping-arrow">→</span>
                                        <input type="text" value="JIRA Status">
                                        <button class="mapping-remove" onclick="removeMapping(this)">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="mapping-item">
                                        <input type="text" value="assignee.displayName">
                                        <span class="mapping-arrow">→</span>
                                        <input type="text" value="Assignee">
                                        <button class="mapping-remove" onclick="removeMapping(this)">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="action-buttons" style="gap: 10px; margin-top: 15px;">
                                    <button class="btn" onclick="addFieldMapping()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        新增欄位對應
                                    </button>
                                    <button class="btn success" onclick="openSmartFieldWizard()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 12l2 2 4-4"/>
                                            <circle cx="12" cy="12" r="10"/>
                                        </svg>
                                        智慧新增欄位
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Smart Field Wizard Section -->
                            <div class="mapping-section" id="smartFieldWizard" style="display: none; margin-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 30px;">
                                <h4>智慧新增欄位精靈 
                                    <button class="btn" onclick="closeSmartFieldWizard()" style="float: right; padding: 4px 8px; font-size: 12px;">
                                        ✕ 關閉
                                    </button>
                                </h4>
                                
                                <!-- Step 1: Ticket Input -->
                                <div class="wizard-step" id="smartStep1">
                                    <h5>步驟 1: 輸入包含新欄位的 Ticket</h5>
                                    <div class="setting-item">
                                        <label class="setting-label">Ticket 號碼</label>
                                        <input type="text" class="setting-input" id="ticketKeyInput" 
                                               placeholder="例如: TP-3153, TCG-1234">
                                        <div class="setting-help">請輸入包含您要新增欄位的 JIRA ticket 號碼</div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn primary" onclick="fetchTicketFields()">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                                <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                                            </svg>
                                            取得 Ticket 欄位
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 2: Field Selection -->
                                <div class="wizard-step" id="smartStep2" style="display: none;">
                                    <h5>步驟 2: 選擇要新增的欄位</h5>
                                    <div class="setting-item">
                                        <label class="setting-label">Ticket 資訊</label>
                                        <div id="ticketInfo" class="info-display">
                                            <!-- Ticket info will be populated here -->
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">可用欄位</label>
                                        <div id="fieldsList" class="fields-list">
                                            <!-- Fields will be populated here -->
                                        </div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" onclick="goBackToStep(1)">← 上一步</button>
                                        <button class="btn primary" id="continueToStep3" onclick="checkFieldExists()" style="display: none;">
                                            繼續 →
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 3: Duplicate Check -->
                                <div class="wizard-step" id="smartStep3" style="display: none;">
                                    <h5>步驟 3: 檢查欄位重複</h5>
                                    <div id="duplicateCheckResult" class="check-result">
                                        <!-- Duplicate check result will be shown here -->
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" onclick="goBackToStep(2)">← 上一步</button>
                                        <button class="btn danger" onclick="closeSmartFieldWizard()" id="cancelButton" style="display: none;">
                                            取消新增
                                        </button>
                                        <button class="btn primary" id="continueToStep4" onclick="loadFieldCategories()" style="display: none;">
                                            繼續 →
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 4: Field Properties -->
                                <div class="wizard-step" id="smartStep4" style="display: none;">
                                    <h5>步驟 4: 選擇欄位屬性</h5>
                                    <div class="setting-item">
                                        <label class="setting-label">欄位分類</label>
                                        <select class="setting-input" id="fieldCategorySelect" onchange="onCategoryChange()">
                                            <option value="">請選擇欄位分類...</option>
                                        </select>
                                        <div class="setting-help">選擇適當的欄位處理方式</div>
                                    </div>
                                    <div id="nestedFieldOptions" style="display: none;">
                                        <div class="setting-item">
                                            <label class="setting-label">嵌套路徑選擇</label>
                                            <select class="setting-input" id="nestedPathSelect">
                                                <option value="">請選擇路徑...</option>
                                            </select>
                                            <div class="setting-help">選擇要提取的嵌套欄位路徑</div>
                                        </div>
                                    </div>
                                    <div id="arrayFieldOptions" style="display: none;">
                                        <div class="setting-item">
                                            <label class="setting-label">陣列元素選擇</label>
                                            <select class="setting-input" id="arrayPathSelect">
                                                <option value="">請選擇元素...</option>
                                            </select>
                                            <div class="setting-help">選擇要提取的陣列元素</div>
                                        </div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" onclick="goBackToStep(3)">← 上一步</button>
                                        <button class="btn primary" id="continueToStep5" onclick="loadLarkFields()" style="display: none;">
                                            繼續 →
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 5: Lark Field Selection -->
                                <div class="wizard-step" id="smartStep5" style="display: none;">
                                    <h5>步驟 5: 選擇 Lark 目標欄位</h5>
                                    <div class="setting-item">
                                        <label class="setting-label">選擇團隊和表格</label>
                                        <select class="setting-input" id="targetTeamSelect" onchange="loadTargetTables()">
                                            <option value="">請選擇團隊...</option>
                                        </select>
                                        <select class="setting-input" id="targetTableSelect" onchange="loadTargetLarkFields()">
                                            <option value="">請先選擇團隊...</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">Lark 欄位</label>
                                        <select class="setting-input" id="larkTargetFieldSelect">
                                            <option value="">請先選擇表格...</option>
                                        </select>
                                        <div class="setting-help">選擇對應的 Lark Base 欄位</div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" onclick="goBackToStep(4)">← 上一步</button>
                                        <button class="btn primary" id="continueToStep6" onclick="showReviewStep()" style="display: none;">
                                            繼續 →
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 6: Review and Confirm -->
                                <div class="wizard-step" id="smartStep6" style="display: none;">
                                    <h5>步驟 6: 審查設定並確認</h5>
                                    <div id="reviewContent" class="review-content">
                                        <!-- Review content will be populated here -->
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" onclick="goBackToStep(5)">← 上一步</button>
                                        <button class="btn danger" onclick="closeSmartFieldWizard()">
                                            取消
                                        </button>
                                        <button class="btn success" onclick="confirmAddField()">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 6L9 17l-5-5"/>
                                            </svg>
                                            確認新增欄位
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Progress Indicator -->
                                <div class="wizard-progress" style="margin-top: 20px;">
                                    <div class="progress-step active" data-step="1">1. 輸入 Ticket</div>
                                    <div class="progress-step" data-step="2">2. 選擇欄位</div>
                                    <div class="progress-step" data-step="3">3. 檢查重複</div>
                                    <div class="progress-step" data-step="4">4. 欄位屬性</div>
                                    <div class="progress-step" data-step="5">5. Lark 欄位</div>
                                    <div class="progress-step" data-step="6">6. 確認新增</div>
                                </div>
                            </div>
                            
                        </div>

                    </div>

                    <!-- Action Bar -->
                    <div class="action-bar">
                        <div class="action-group">
                            <button class="btn primary" onclick="saveAllSettings()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17,21 17,13 7,13 7,21"/>
                                    <polyline points="7,3 7,8 15,8"/>
                                </svg>
                                儲存所有設定
                            </button>
                            <button class="btn success" onclick="testAllConnections()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                測試所有連線
                            </button>
                        </div>
                        <div class="action-group">
                            <button class="btn warning" onclick="editConfigFile()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                編輯配置檔
                            </button>
                            <button class="btn danger" onclick="resetAllSettings()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19,6V20a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6M8,6V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2V6"/>
                                </svg>
                                重設為預設值
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域配置版本管理
        let currentConfigVersion = null;
        let configVersionCheckInterval = null;
        
        // 團隊選單收折功能
        function toggleTeamMenu(teamId) {
            const menuElement = document.getElementById(teamId + '-menu');
            const navItem = menuElement.previousElementSibling;
            
            if (menuElement.classList.contains('expanded')) {
                menuElement.classList.remove('expanded');
                navItem.classList.remove('expanded');
            } else {
                // 展開當前選單
                menuElement.classList.add('expanded');
                navItem.classList.add('expanded');
            }
        }

        // 內容切換功能
        function showContent(contentType, teamName = '', tableName = '') {
            // 隱藏所有內容區域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 移除所有活躍狀態
            document.querySelectorAll('.nav-item.active, .submenu-item.active').forEach(activeItem => {
                activeItem.classList.remove('active');
            });
            
            // 顯示指定的內容區域
            const targetContent = document.getElementById(contentType + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
                
                // 如果是表格設定頁面，載入表格設定
                if (contentType === 'table-settings' && teamName && tableName) {
                    showTableSettings(teamName, tableName);
                    return; // 讓 showTableSettings 處理導航
                }
                
                // 如果是系統設定頁面，載入設定
                if (contentType === 'system-settings') {
                    loadSystemSettings();
                }
            }
        }
        
        // 全域儲存團隊配置
        let globalTeamsConfig = {};

        // 更新表格設定頁面資訊
        function updateTableSettingsPage(teamName, tableName) {
            // 從全域配置中獲取顯示名稱
            let displayTableName = tableName;
            let displayTeamName = teamName.toUpperCase();
            
            if (globalTeamsConfig[teamName]) {
                displayTeamName = globalTeamsConfig[teamName].display_name || teamName.toUpperCase();
                
                if (globalTeamsConfig[teamName].tables[tableName]) {
                    displayTableName = globalTeamsConfig[teamName].tables[tableName].display_name || tableName;
                }
            }
            
            // 更新頁面標題和麵包屑
            document.getElementById('current-table-name').textContent = displayTableName;
            document.getElementById('table-title').textContent = displayTableName;
            document.getElementById('team-name').textContent = displayTeamName;
            
            // 更新表單預設值
            document.getElementById('table-name-input').value = displayTableName;
        }

        // 導航項目點擊
        document.querySelectorAll('.nav-item:not([onclick]), .submenu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 移除所有活躍狀態
                document.querySelectorAll('.nav-item.active, .submenu-item.active').forEach(activeItem => {
                    activeItem.classList.remove('active');
                });
                
                // 添加活躍狀態到當前項目
                this.classList.add('active');
                
                // 根據點擊的項目決定顯示哪個內容
                const href = this.getAttribute('href');
                if (href) {
                    if (href.includes('system_settings.html')) {
                        showContent('system-settings');
                    } else if (href.includes('table_settings.html')) {
                        // 從 URL 參數解析團隊和表格名稱
                        const url = new URL(href, window.location.origin);
                        const team = url.searchParams.get('team');
                        const table = url.searchParams.get('table');
                        showContent('table-settings', team, table);
                    }
                } else {
                    // 處理其他導航項目（如首頁）
                    const text = this.textContent.trim();
                    if (text.includes('系統設定')) {
                        showContent('system-settings');
                    } else {
                        // 預設顯示 dashboard
                        showContent('dashboard');
                    }
                }
                
                console.log('導航到:', this.textContent.trim());
            });
        });

        // 按鈕點擊事件
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.textContent.trim();
                console.log(`執行操作: ${action}`);
                
                // 判斷是否需要確認框
                if (action === '開始所有同步' || action === '暫停所有同步' || action === '全量更新') {
                    let message = '';
                    let title = '';
                    
                    switch(action) {
                        case '開始所有同步':
                            message = '確定要啟動所有團隊的同步作業嗎？';
                            title = '確認開始同步';
                            break;
                        case '暫停所有同步':
                            message = '確定要暫停所有團隊的同步作業嗎？';
                            title = '確認暫停同步';
                            break;
                        case '全量更新':
                            message = '全量更新將重新同步所有記錄，可能需要 5-10 分鐘時間。確定要執行嗎？';
                            title = '確認全量更新';
                            break;
                    }
                    
                    showConfirm(message, title, () => {
                        executeAction(action, this);
                    });
                } else {
                    executeAction(action, this);
                }
            });
        });

        // API 基礎 URL
        const API_BASE = '';

        // API 調用輔助函數
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data !== null) {
                    options.body = JSON.stringify(data);
                } else if (method === 'POST' || method === 'PUT' || method === 'PATCH') {
                    // 對於 POST/PUT/PATCH 請求，如果沒有提供 data，傳送空物件
                    options.body = JSON.stringify({});
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                return result;
            } catch (error) {
                console.error('API 調用錯誤:', error);
                return {
                    status: 'error',
                    message: `網路錯誤: ${error.message}`
                };
            }
        }

        // 配置版本管理函數
        async function loadConfigVersion() {
            try {
                const result = await apiCall('/api/config/version');
                if (result.status === 'success') {
                    currentConfigVersion = result.version;
                }
            } catch (error) {
                console.error('載入配置版本失敗:', error);
            }
        }
        
        async function checkConfigVersion() {
            try {
                const result = await apiCall('/api/config/version');
                if (result.status === 'success') {
                    if (currentConfigVersion && result.version !== currentConfigVersion) {
                        // 配置已被其他用戶修改
                        showConfigModifiedWarning();
                    }
                }
            } catch (error) {
                console.error('檢查配置版本失敗:', error);
            }
        }
        
        function showConfigModifiedWarning() {
            showConfirm(
                '⚠️ 檢測到配置檔案已被其他用戶修改！<br><br>' +
                '建議重新載入頁面以獲取最新配置，避免覆蓋其他人的變更。<br><br>' +
                '是否要重新載入頁面？',
                '配置檔案已變更',
                () => {
                    window.location.reload();
                },
                () => {
                    // 更新本地版本號避免重複提示
                    loadConfigVersion();
                }
            );
        }
        
        function startConfigVersionCheck() {
            // 每 30 秒檢查一次配置版本
            configVersionCheckInterval = setInterval(checkConfigVersion, 30000);
        }
        
        function stopConfigVersionCheck() {
            if (configVersionCheckInterval) {
                clearInterval(configVersionCheckInterval);
                configVersionCheckInterval = null;
            }
        }
        
        async function safeApiCall(endpoint, method = 'GET', data = null, includeVersion = true) {
            // 安全的 API 調用，包含版本檢查
            if (includeVersion && currentConfigVersion && data) {
                data._config_version = currentConfigVersion;
            }
            
            const result = await apiCall(endpoint, method, data);
            
            // 處理版本衝突
            if (result.error_type === 'version_conflict') {
                const shouldReload = await showVersionConflictDialog(result);
                if (shouldReload) {
                    window.location.reload();
                    return null;
                }
            }
            
            // 更新配置版本
            if (result.config_version) {
                currentConfigVersion = result.config_version;
            }
            
            return result;
        }
        
        function showVersionConflictDialog(conflictInfo) {
            return new Promise((resolve) => {
                showConfirm(
                    '⚠️ 配置檔案版本衝突！<br><br>' +
                    '您的變更與其他用戶的修改發生衝突。<br><br>' +
                    '請選擇操作：<br>' +
                    '• 重新載入頁面獲取最新配置<br>' +
                    '• 繼續嘗試儲存（可能覆蓋其他人的變更）',
                    '版本衝突',
                    () => resolve(true),  // 重新載入
                    () => resolve(false)  // 繼續嘗試
                );
            });
        }

        // 載入系統狀態
        async function loadSystemStatus() {
            try {
                const result = await apiCall('/api/status');
                
                if (result.status) {
                    updateSystemStatusUI(result);
                }
            } catch (error) {
                console.error('載入系統狀態失敗:', error);
            }
        }

        // 載入團隊配置並生成側邊欄
        async function loadTeamsConfig() {
            try {
                const teamsConfig = await apiCall('/api/config/teams');
                
                if (teamsConfig && !teamsConfig.error) {
                    generateTeamsSidebar(teamsConfig);
                }
            } catch (error) {
                console.error('載入團隊配置失敗:', error);
                // 如果載入失敗，顯示錯誤訊息但不中斷程序
                console.warn('將使用預設團隊配置');
            }
        }

        // 生成團隊側邊欄
        function generateTeamsSidebar(teamsConfig) {
            // 儲存配置到全域變數
            globalTeamsConfig = teamsConfig;
            
            const teamsSection = document.getElementById('teams-section');
            const title = teamsSection.querySelector('.nav-section-title');
            
            // 清除現有內容（保留標題）
            teamsSection.innerHTML = '';
            teamsSection.appendChild(title);
            
            // 團隊圖示對應
            const teamIcons = {
                'ard': 'M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H16c-.8 0-1.54.37-2.01 1l-2.2 2.94L9 10.5v-1h2c1.1 0 2-.9 2-2s-.9-2-2-2H8c-1.1 0-2 .9-2 2s.9 2 2 2h1v1l-2.8 1.86L4 11.86v2.83L6.2 16c.8.53 1.8.8 2.8.8H12l3.55 4.28A1 1 0 0 0 16.34 22H20v-6z',
                'management': 'M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10z',
                'aid_trm': 'M7 2v11h3v9l7-12h-4l4-8z',
                'default': 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'
            };
            
            // 為每個團隊生成選單項目
            Object.keys(teamsConfig).forEach(teamName => {
                const teamData = teamsConfig[teamName];
                const teamDisplayName = teamData.display_name || teamName.toUpperCase();
                const iconPath = teamIcons[teamName] || teamIcons.default;
                
                // 創建團隊主選單項目
                const teamDiv = document.createElement('div');
                teamDiv.className = 'nav-item team-nav-item';
                
                teamDiv.innerHTML = `
                    <div class="nav-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="${iconPath}"/>
                        </svg>
                    </div>
                    <div class="nav-text" onclick="showTeamSettings('${teamName}')">${teamDisplayName}</div>
                    <div class="team-status running"></div>
                    <div class="nav-arrow" onclick="toggleTeamMenu('${teamName}')">▶</div>
                `;
                
                // 創建子選單
                const submenuDiv = document.createElement('div');
                submenuDiv.className = 'team-submenu';
                submenuDiv.id = `${teamName}-menu`;
                
                // 為每個表格生成子選單項目
                Object.keys(teamData.tables).forEach((tableName, index) => {
                    const tableData = teamData.tables[tableName];
                    
                    if (tableData.enabled) {
                        const tableLink = document.createElement('a');
                        tableLink.href = '#';
                        tableLink.className = 'submenu-item';
                        tableLink.onclick = (e) => {
                            e.preventDefault();
                            showContent('table-settings', teamName, tableName);
                            return false;
                        };
                        
                        // 第一個表格設為預設活躍
                        if (index === 0) {
                            tableLink.classList.add('active');
                        }
                        
                        tableLink.innerHTML = `
                            <div class="submenu-icon"></div>
                            <div class="submenu-text">${tableData.display_name}</div>
                        `;
                        
                        submenuDiv.appendChild(tableLink);
                    }
                });
                
                // 將團隊項目和子選單添加到側邊欄
                teamsSection.appendChild(teamDiv);
                teamsSection.appendChild(submenuDiv);
            });
            
            console.log('團隊側邊欄已動態生成');
        }

        // 更新系統狀態 UI
        function updateSystemStatusUI(statusData) {
            // 更新系統狀態
            const statusElement = document.querySelector('.status-value');
            if (statusElement && statusData.status) {
                statusElement.textContent = statusData.status === 'running' ? '執行中' : '已停止';
            }
            
            // 更新活躍團隊數
            const activeTeamsElement = document.querySelector('.status-card:nth-child(2) .status-value');
            if (activeTeamsElement && statusData.teams) {
                activeTeamsElement.textContent = `${statusData.teams.active}/${statusData.teams.total} 個團隊`;
            }
            
            // 更新系統運行時間
            const uptimeElement = document.querySelector('.status-card:nth-child(3) .status-value');
            if (uptimeElement && statusData.uptime) {
                uptimeElement.textContent = statusData.uptime;
            }
            
        }

        
        // 執行實際操作的函數
        async function executeAction(action, buttonElement) {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = '執行中...';
            buttonElement.disabled = true;
            
            try {
                let result;
                let endpoint;
                let method = 'POST';
                
                // 根據不同操作調用對應的 API 端點
                switch(action) {
                    case '開始所有同步':
                        endpoint = '/api/sync/start';
                        break;
                    case '暫停所有同步':
                        endpoint = '/api/sync/stop';
                        break;
                    case '全量更新':
                        endpoint = '/api/sync/full-update';
                        break;
                    case '查看日誌':
                        showLogViewer();
                        return;
                    default:
                        showToast(`${action} 操作完成`, 'info', '操作完成');
                        return;
                }
                
                // 調用 API
                result = await apiCall(endpoint, method);
                
                // 根據結果顯示通知
                if (result.status === 'success') {
                    showToast(result.message, 'success', '操作成功');
                    
                    // 如果是全量更新，顯示額外資訊
                    if (action === '全量更新' && result.duration) {
                        setTimeout(() => {
                            showToast(`全量更新完成，耗時 ${result.duration} 秒`, 'info', '更新完成');
                        }, 1000);
                    }
                } else if (result.status === 'warning') {
                    showToast(result.message, 'warning', '操作提醒');
                } else {
                    showToast(result.message || '操作失敗', 'error', '操作失敗');
                }
                
                // 操作成功後重新載入系統狀態
                if (result.status === 'success') {
                    setTimeout(() => {
                        loadSystemStatus();
                    }, 500);
                }
                
            } catch (error) {
                console.error('執行操作失敗:', error);
                showToast('操作執行失敗，請稍後重試', 'error', '操作失敗');
            } finally {
                // 恢復按鈕狀態
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            }
        }

        // 主題切換功能
        function toggleTheme() {
            const body = document.body;
            const themeIconPath = document.getElementById('theme-icon-path');
            
            body.classList.toggle('light-mode');
            
            // 切換圖示
            if (body.classList.contains('light-mode')) {
                // 日間模式 - 太陽圖示
                themeIconPath.setAttribute('d', 'M12,18V6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,15.31L23.31,12L20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31Z');
                localStorage.setItem('theme', 'light');
            } else {
                // 夜間模式 - 月亮圖示
                themeIconPath.setAttribute('d', 'M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.4 6.35,17.41C9.37,20.43 14,20.54 17.33,17.97Z');
                localStorage.setItem('theme', 'dark');
            }
        }

        // 載入保存的主題設定
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIconPath = document.getElementById('theme-icon-path');
            
            if (savedTheme === 'light') {
                body.classList.add('light-mode');
                themeIconPath.setAttribute('d', 'M12,18V6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,15.31L23.31,12L20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31Z');
            }
        }

        // 快速建立資料表功能
        function openTableCreator(event) {
            event.preventDefault();
            
            // 移除所有活躍狀態
            document.querySelectorAll('.nav-item.active, .submenu-item.active').forEach(activeItem => {
                activeItem.classList.remove('active');
            });
            
            // 添加活躍狀態到當前項目
            event.currentTarget.classList.add('active');
            
            console.log('開啟快速建立資料表模式');
            
            // TODO: 在這裡實作快速建立資料表的界面
            showToast('快速建立資料表功能開發中...', 'info', '功能開發中');
        }

        // Custom Confirm Dialog
        function showConfirm(message, title, onConfirm, onCancel = null) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.display = 'flex';
            
            overlay.innerHTML = `
                <div class="modal">
                    <div class="modal-title">${title}</div>
                    <div style="margin: 20px 0; line-height: 1.5;">${message}</div>
                    <div class="modal-actions">
                        <button class="modal-btn secondary" onclick="closeConfirm(this, false)">取消</button>
                        <button class="modal-btn primary" onclick="closeConfirm(this, true)">確認</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Store callbacks
            overlay._onConfirm = onConfirm;
            overlay._onCancel = onCancel;
        }

        function closeConfirm(button, confirmed) {
            const overlay = button.closest('.modal-overlay');
            
            if (confirmed && overlay._onConfirm) {
                overlay._onConfirm();
            } else if (!confirmed && overlay._onCancel) {
                overlay._onCancel();
            }
            
            overlay.remove();
        }

        // Custom Toast Notification System
        function showToast(message, type = 'info', title = '') {
            // 確保 toast 容器存在
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    pointer-events: none;
                `;
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.cssText = `
                position: relative;
                background: rgba(26, 26, 26, 0.95);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 15px 20px;
                color: #ffffff;
                font-size: 14px;
                transform: translateX(400px);
                transition: all 0.3s ease;
                max-width: 350px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                margin-bottom: 10px;
                pointer-events: auto;
                ${type === 'info' ? 'border-left: 4px solid #4fc3f7;' : ''}
                ${type === 'success' ? 'border-left: 4px solid #66bb6a;' : ''}
                ${type === 'warning' ? 'border-left: 4px solid #ffc107;' : ''}
                ${type === 'error' ? 'border-left: 4px solid #f44336;' : ''}
            `;
            
            if (document.body.classList.contains('light-mode')) {
                toast.style.background = 'rgba(255, 255, 255, 0.95)';
                toast.style.border = '1px solid rgba(0, 0, 0, 0.1)';
                toast.style.color = '#2d2d2d';
                toast.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.1)';
            }
            
            const icons = {
                success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>',
                error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>'
            };
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-weight: 500;">
                    <div style="width: 16px; height: 16px;">${icons[type]}</div>
                    ${title}
                    <button onclick="removeToast(this)" style="margin-left: auto; background: none; border: none; color: inherit; cursor: pointer; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div style="font-size: 13px; line-height: 1.4; opacity: 0.9;">${message}</div>
            `;
            
            // 將新的 toast 添加到容器底部
            toastContainer.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                removeToast(toast.querySelector('button'));
            }, 4000);
        }
        
        // 移除 toast 的函數
        function removeToast(button) {
            const toast = button.closest('.toast');
            if (toast && toast.parentElement) {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                        
                        // 如果容器中沒有 toast 了，清理容器
                        const container = document.getElementById('toast-container');
                        if (container && container.children.length === 0) {
                            container.remove();
                        }
                    }
                }, 300);
            }
        }

        // 表格設定相關功能
        function toggleTableStatus() {
            const toggle = document.getElementById('masterToggle');
            const statusIndicator = document.getElementById('tableStatus');
            
            if (toggle.classList.contains('active')) {
                toggle.classList.remove('active');
                statusIndicator.innerHTML = '<span>●</span><span>已暫停</span>';
                statusIndicator.style.color = '#ffc107';
                showToast('表格同步已暫停', 'warning', '狀態變更');
            } else {
                toggle.classList.add('active');
                statusIndicator.innerHTML = '<span>●</span><span>執行中</span>';
                statusIndicator.style.color = '#66bb6a';
                showToast('表格同步已啟用', 'success', '狀態變更');
            }
        }

        function syncTable() {
            showToast('表格同步已開始執行', 'success', '同步開始');
        }

        function fullUpdateTable() {
            showConfirm('全量更新將重新同步所有記錄，可能需要較長時間。確定要執行嗎？', '確認全量更新', () => {
                showToast('全量更新已開始，請稍候...', 'info', '全量更新');
            });
        }


        async function testConnection() {
            try {
                showToast('測試中...', 'info', '連線測試');
                
                // 測試 JIRA 和 Lark 連線
                const [jiraResult, larkResult] = await Promise.all([
                    apiCall('/api/test/jira', 'GET'),
                    apiCall('/api/test/lark', 'POST', {})
                ]);
                
                let results = [];
                let allSuccess = true;
                
                if (jiraResult.status === 'success') {
                    results.push('✓ JIRA 連線正常');
                } else {
                    results.push('✗ JIRA 連線失敗');
                    allSuccess = false;
                }
                
                if (larkResult.status === 'success') {
                    results.push('✓ Lark 連線正常');
                } else {
                    results.push('✗ Lark 連線失敗');
                    allSuccess = false;
                }
                
                const message = results.join('\n');
                showToast(message, allSuccess ? 'success' : 'error', '連線測試');
                
            } catch (error) {
                console.error('連線測試錯誤:', error);
                showToast('連線測試失敗', 'error', '連線測試');
            }
        }

        function toggleDryRun() {
            const checkbox = document.getElementById('dry-run-toggle');
            checkbox.checked = !checkbox.checked;
            showToast(checkbox.checked ? '已啟用乾跑模式' : '已停用乾跑模式', 'info', '設定變更');
        }

        // 系統設定相關功能
        async function saveSystemSettings() {
            try {
                showToast('正在儲存...', 'info', '儲存設定');
                
                // 收集系統設定表單資料
                const systemConfig = {
                    global: {
                        default_sync_interval: parseInt(document.getElementById('globalPollInterval').value),
                        log_level: document.getElementById('logLevel').value
                    },
                    jira: {
                        server_url: document.getElementById('jiraServerUrl').value,
                        username: document.getElementById('jiraUsername').value
                        // 密碼不從前端傳送，保持現有配置
                    },
                    lark_base: {
                        app_id: document.getElementById('larkAppId').value,
                        base_url: document.getElementById('larkBaseUrl').value
                        // app_secret 不從前端傳送，保持現有配置
                    }
                };
                
                const response = await apiCall('/api/config/system', 'POST', systemConfig);
                
                if (response.status === 'success') {
                    showToast('系統設定已儲存', 'success', '儲存成功');
                } else {
                    showToast(response.message || '儲存失敗', 'error', '儲存失敗');
                }
            } catch (error) {
                console.error('儲存系統設定錯誤:', error);
                showToast('儲存失敗', 'error', '儲存失敗');
            }
        }

        async function testSystemConnection() {
            try {
                showToast('測試中...', 'info', '連線測試');
                
                // 測試 JIRA 和 Lark 連線
                const [jiraResult, larkResult] = await Promise.all([
                    apiCall('/api/test/jira', 'GET'),
                    apiCall('/api/test/lark', 'POST', {})
                ]);
                
                let results = [];
                let allSuccess = true;
                
                if (jiraResult.status === 'success') {
                    results.push('✓ JIRA 連線正常');
                } else {
                    results.push('✗ JIRA 連線失敗');
                    allSuccess = false;
                }
                
                if (larkResult.status === 'success') {
                    results.push('✓ Lark 連線正常');
                } else {
                    results.push('✗ Lark 連線失敗');
                    allSuccess = false;
                }
                
                const message = results.join('\n');
                showToast(message, allSuccess ? 'success' : 'error', '連線測試');
                
            } catch (error) {
                console.error('連線測試錯誤:', error);
                showToast('連線測試失敗', 'error', '連線測試');
            }
        }

        function resetSystemSettings() {
            showConfirm('確定要重設所有系統設定為預設值嗎？此操作無法復原。', '確認重設設定', () => {
                showToast('系統設定已重設為預設值', 'success', '重設完成');
            });
        }

        // JQL 功能
        function validateJQL() {
            const jqlInput = document.getElementById('jqlQuery');
            const result = document.getElementById('jqlResult');
            const jql = jqlInput.value.trim();
            
            if (!jql) {
                result.innerHTML = '<span class="result-error"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> 請輸入 JQL 查詢語句</span>';
                return;
            }
            
            result.innerHTML = '<span class="result-loading"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> 驗證中...</span>';
            
            // 模擬驗證
            setTimeout(() => {
                if (jql.toLowerCase().includes('project =') || jql.toLowerCase().includes('project in')) {
                    result.innerHTML = '<span class="result-success"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg> 語法正確</span>';
                } else {
                    result.innerHTML = '<span class="result-error"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> 語法錯誤：缺少 project 條件</span>';
                }
            }, 1000);
        }

        function testJQLQuery() {
            const jqlInput = document.getElementById('jqlQuery');
            const result = document.getElementById('jqlResult');
            const queryResults = document.getElementById('queryResults');
            const resultsCount = document.getElementById('resultsCount');
            const tableBody = document.getElementById('resultsTableBody');
            const jql = jqlInput.value.trim();
            
            if (!jql) {
                result.innerHTML = '<span class="result-error"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> 請輸入 JQL 查詢語句</span>';
                queryResults.style.display = 'none';
                return;
            }
            
            result.innerHTML = '<span class="result-loading"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/></svg> 測試查詢中...</span>';
            queryResults.style.display = 'none';
            
            // 模擬查詢測試
            setTimeout(() => {
                if (Math.random() > 0.1) {
                    const mockData = generateMockJQLResults();
                    
                    result.innerHTML = `<span class="result-success"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg> 查詢成功，找到 ${mockData.length} 筆記錄</span>`;
                    resultsCount.textContent = `${mockData.length} 筆記錄`;
                
                    // 清空並填充表格
                    tableBody.innerHTML = '';
                    
                    if (mockData.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="loading-row">沒有找到符合條件的記錄</td></tr>';
                    } else {
                        mockData.forEach(issue => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><span class="issue-key">${issue.key}</span></td>
                                <td><div class="issue-title" title="${issue.summary}">${issue.summary}</div></td>
                                <td><span class="status-badge ${getStatusClass(issue.status)}">${issue.status}</span></td>
                                <td>${issue.assignee || '未分配'}</td>
                                <td><span class="priority-badge ${getPriorityClass(issue.priority)}">${issue.priority}</span></td>
                                <td>${formatDate(issue.updated)}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                    
                    queryResults.style.display = 'block';
                } else {
                    result.innerHTML = '<span class="result-error"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> 查詢失敗：連線錯誤</span>';
                    queryResults.style.display = 'none';
                }
            }, 2000);
        }

        function showJQLExamples() {
            const examples = [
                'project = TP AND status IN (Open, "In Progress")',
                'project = TCG AND updated >= -7d',
                'assignee = currentUser() AND status != Closed',
                'project IN (TP, TCG) AND component = CRM'
            ];
            
            const jqlInput = document.getElementById('jqlQuery');
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            jqlInput.value = randomExample;
            
            showToast('JQL 範例已填入', 'info', '範例');
        }

        // 輔助函數
        function generateMockJQLResults() {
            const keys = ['TP-1234', 'TP-1235', 'TCG-567', 'TCG-568', 'TP-1236'];
            const summaries = [
                '修復登入頁面驗證問題',
                '新增用戶管理功能',
                '優化資料庫查詢效能',
                '更新API文檔',
                '修復報表生成錯誤'
            ];
            const statuses = ['Open', 'In Progress', 'Resolved', 'Closed'];
            const assignees = ['John Doe', 'Jane Smith', 'Bob Wilson', null];
            const priorities = ['High', 'Medium', 'Low'];
            
            const count = Math.floor(Math.random() * 10) + 1;
            const results = [];
            
            for (let i = 0; i < count; i++) {
                results.push({
                    key: keys[Math.floor(Math.random() * keys.length)],
                    summary: summaries[Math.floor(Math.random() * summaries.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    assignee: assignees[Math.floor(Math.random() * assignees.length)],
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    updated: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)
                });
            }
            
            return results;
        }

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'open': return 'open';
                case 'in progress': return 'in-progress';
                case 'resolved': return 'closed';
                case 'closed': return 'closed';
                default: return 'open';
            }
        }

        function getPriorityClass(priority) {
            switch (priority.toLowerCase()) {
                case 'high': return 'high';
                case 'medium': return 'medium';
                case 'low': return 'low';
                default: return 'medium';
            }
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 系統設定功能
        function toggleSetting(settingId) {
            const toggle = document.getElementById(settingId);
            toggle.classList.toggle('active');
            const isActive = toggle.classList.contains('active');
            showToast(`${settingId} 設定已${isActive ? '啟用' : '停用'}`, 'info', '設定變更');
        }

        function removeMapping(button) {
            button.parentElement.remove();
        }


        async function saveAllSettings() {
            showToast('正在儲存設定...', 'info', '儲存中');
            
            try {
                // 收集所有設定資料（密碼和 secret 不更新）
                const settings = {
                    global: {
                        default_sync_interval: parseInt(document.getElementById('globalPollInterval').value),
                        log_level: document.getElementById('logLevel').value
                    },
                    jira: {
                        server_url: document.getElementById('jiraServerUrl').value,
                        username: document.getElementById('jiraUsername').value
                        // 密碼欄位被跳過，保持配置檔中的原值
                    },
                    lark_base: {
                        app_id: document.getElementById('larkAppId').value,
                        base_url: document.getElementById('larkBaseUrl').value
                        // app_secret 欄位被跳過，保持配置檔中的原值
                    },
                    field_mappings: {
                        ticket_fields: collectTicketFields(),
                        jira_to_lark: collectFieldMappings()
                    }
                };
                
                // 驗證設定
                const validateResponse = await fetch('/api/config/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const validateResult = await validateResponse.json();
                if (validateResult.status !== 'success') {
                    showToast(validateResult.message, 'error', '驗證失敗');
                    if (validateResult.errors) {
                        console.error('驗證錯誤:', validateResult.errors);
                    }
                    return;
                }
                
                // 儲存設定 - 使用安全API調用
                const result = await safeApiCall('/api/config/system', 'POST', settings);
                
                if (!result) {
                    // 版本衝突被處理，使用者選擇重新載入
                    return;
                }
                if (result.status === 'success') {
                    showToast('所有設定已成功儲存', 'success', '儲存完成');
                } else {
                    showToast(result.message, 'error', '儲存失敗');
                }
                
            } catch (error) {
                console.error('儲存設定時發生錯誤:', error);
                showToast('儲存設定時發生錯誤', 'error', '儲存失敗');
            }
        }

        // 收集票據欄位資料
        function collectTicketFields() {
            const ticketFieldsContainer = document.getElementById('ticketFields');
            const inputs = ticketFieldsContainer.querySelectorAll('input[type="text"]');
            return Array.from(inputs).map(input => input.value.trim()).filter(value => value);
        }
        
        // 收集欄位對應資料
        function collectFieldMappings() {
            const mappingsContainer = document.getElementById('fieldMappings');
            const mappingItems = mappingsContainer.querySelectorAll('.mapping-item');
            const mappings = {};
            
            mappingItems.forEach(item => {
                const jiraField = item.querySelector('.jira-field')?.value.trim() || '';
                const larkField = item.querySelector('.lark-field')?.value.trim() || '';
                const processor = item.querySelector('.processor-select')?.value || 'extract_simple';
                const nestedPath = item.querySelector('.nested-path')?.value.trim() || '';
                const fieldType = item.querySelector('.field-type-select')?.value || '';
                
                if (jiraField && larkField) {
                    const config = {
                        lark_field: larkField.includes(',') ? larkField.split(',').map(f => f.trim()) : larkField,
                        processor: processor
                    };
                    
                    if (processor === 'extract_nested' && nestedPath) {
                        config.nested_path = nestedPath;
                    }
                    
                    if ((processor === 'extract_components' || processor === 'extract_versions') && fieldType) {
                        config.field_type = fieldType;
                    }
                    
                    mappings[jiraField] = config;
                }
            });
            
            return mappings;
        }
        
        // 載入系統設定
        async function loadSystemSettings() {
            try {
                const response = await fetch('/api/config/system');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const config = result.config;
                    
                    // 載入全域設定
                    if (config.global) {
                        if (config.global.default_sync_interval) {
                            document.getElementById('globalPollInterval').value = config.global.default_sync_interval;
                        }
                        if (config.global.log_level) {
                            document.getElementById('logLevel').value = config.global.log_level;
                        }
                    }
                    
                    // 載入 JIRA 設定
                    if (config.jira) {
                        if (config.jira.server_url) {
                            document.getElementById('jiraServerUrl').value = config.jira.server_url;
                        }
                        if (config.jira.username) {
                            document.getElementById('jiraUsername').value = config.jira.username;
                        }
                        if (config.jira.password) {
                            document.getElementById('jiraPassword').value = config.jira.password;
                        }
                    }
                    
                    // 載入 Lark Base 設定
                    if (config.lark_base) {
                        if (config.lark_base.app_id) {
                            document.getElementById('larkAppId').value = config.lark_base.app_id;
                        }
                        if (config.lark_base.app_secret) {
                            document.getElementById('larkAppSecret').value = config.lark_base.app_secret;
                        }
                        if (config.lark_base.base_url) {
                            document.getElementById('larkBaseUrl').value = config.lark_base.base_url;
                        }
                    }
                    
                    // 載入欄位對應設定
                    if (config.field_mappings) {
                        console.log('Loading field mappings:', config.field_mappings);
                        loadTicketFields(config.field_mappings.ticket_fields || []);
                        loadFieldMappings(config.field_mappings.jira_to_lark || {});
                    }
                }
            } catch (error) {
                console.error('載入系統設定時發生錯誤:', error);
                showToast('載入系統設定失敗', 'error', '載入失敗');
            }
        }
        
        // 載入票據欄位
        function loadTicketFields(ticketFields) {
            const container = document.getElementById('ticketFields');
            container.innerHTML = '';
            
            ticketFields.forEach(field => {
                const item = document.createElement('div');
                item.className = 'mapping-item';
                item.innerHTML = `
                    <input type="text" value="${field}">
                    <button class="mapping-remove" onclick="removeMapping(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                `;
                container.appendChild(item);
            });
        }
        
        // 載入欄位對應
        function loadFieldMappings(mappings) {
            console.log('loadFieldMappings called with:', mappings);
            const container = document.getElementById('fieldMappings');
            console.log('Container found:', container);
            container.innerHTML = '';
            
            Object.entries(mappings).forEach(([jiraField, config]) => {
                console.log('Creating mapping:', jiraField, '->', config);
                
                // 處理 lark_field，可能是字符串或數組
                let larkField = config.lark_field || '';
                if (Array.isArray(larkField)) {
                    larkField = larkField.join(', ');
                }
                
                const processor = config.processor || 'extract_simple';
                const nestedPath = config.nested_path || '';
                const fieldType = config.field_type || '';
                
                const item = document.createElement('div');
                item.className = 'mapping-item';
                item.innerHTML = `
                    <div class="mapping-row">
                        <input type="text" placeholder="JIRA 欄位" value="${jiraField}" class="jira-field">
                        <span class="mapping-arrow">→</span>
                        <input type="text" placeholder="Lark 欄位" value="${larkField}" class="lark-field">
                        <select class="processor-select">
                            <option value="extract_simple" ${processor === 'extract_simple' ? 'selected' : ''}>簡單提取</option>
                            <option value="extract_nested" ${processor === 'extract_nested' ? 'selected' : ''}>嵌套提取</option>
                            <option value="extract_user" ${processor === 'extract_user' ? 'selected' : ''}>用戶提取</option>
                            <option value="convert_datetime" ${processor === 'convert_datetime' ? 'selected' : ''}>日期轉換</option>
                            <option value="extract_components" ${processor === 'extract_components' ? 'selected' : ''}>組件提取</option>
                            <option value="extract_versions" ${processor === 'extract_versions' ? 'selected' : ''}>版本提取</option>
                            <option value="extract_links" ${processor === 'extract_links' ? 'selected' : ''}>連結提取</option>
                            <option value="extract_ticket_link" ${processor === 'extract_ticket_link' ? 'selected' : ''}>票據連結</option>
                        </select>
                        <button class="mapping-remove" onclick="removeMapping(this)">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="mapping-options" style="display: ${processor === 'extract_nested' ? 'block' : 'none'}">
                        <input type="text" placeholder="嵌套路徑 (例如: name)" value="${nestedPath}" class="nested-path">
                    </div>
                    <div class="mapping-options" style="display: ${processor === 'extract_components' || processor === 'extract_versions' ? 'block' : 'none'}">
                        <select class="field-type-select">
                            <option value="" ${fieldType === '' ? 'selected' : ''}>預設格式</option>
                            <option value="multiselect" ${fieldType === 'multiselect' ? 'selected' : ''}>多選欄位</option>
                        </select>
                    </div>
                `;
                container.appendChild(item);
                
                // Add event listener for processor changes
                const processorSelect = item.querySelector('.processor-select');
                const nestedOptions = item.querySelector('.mapping-options:nth-child(2)');
                const typeOptions = item.querySelector('.mapping-options:nth-child(3)');
                
                processorSelect.addEventListener('change', function() {
                    const processor = this.value;
                    if (nestedOptions) {
                        nestedOptions.style.display = processor === 'extract_nested' ? 'block' : 'none';
                    }
                    if (typeOptions) {
                        typeOptions.style.display = (processor === 'extract_components' || processor === 'extract_versions') ? 'block' : 'none';
                    }
                });
            });
            console.log('Field mappings loaded, container now has', container.children.length, 'items');
        }
        
        // 新增票據欄位
        function addTicketField() {
            const container = document.getElementById('ticketFields');
            const item = document.createElement('div');
            item.className = 'mapping-item';
            item.innerHTML = `
                <input type="text" placeholder="欄位名稱">
                <button class="mapping-remove" onclick="removeMapping(this)">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `;
            container.appendChild(item);
        }
        
        // 新增欄位對應
        function addFieldMapping() {
            const container = document.getElementById('fieldMappings');
            const item = document.createElement('div');
            item.className = 'mapping-item';
            item.innerHTML = `
                <div class="mapping-row">
                    <input type="text" placeholder="JIRA 欄位" class="jira-field">
                    <span class="mapping-arrow">→</span>
                    <input type="text" placeholder="Lark 欄位" class="lark-field">
                    <select class="processor-select">
                        <option value="extract_simple">簡單提取</option>
                        <option value="extract_nested">嵌套提取</option>
                        <option value="extract_user">用戶提取</option>
                        <option value="convert_datetime">日期轉換</option>
                        <option value="extract_components">組件提取</option>
                        <option value="extract_versions">版本提取</option>
                        <option value="extract_links">連結提取</option>
                        <option value="extract_ticket_link">票據連結</option>
                    </select>
                    <button class="mapping-remove" onclick="removeMapping(this)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="mapping-options" style="display: none">
                    <input type="text" placeholder="嵌套路徑 (例如: name)" class="nested-path">
                </div>
                <div class="mapping-options" style="display: none">
                    <select class="field-type-select">
                        <option value="">預設格式</option>
                        <option value="multiselect">多選欄位</option>
                    </select>
                </div>
            `;
            container.appendChild(item);
            
            // Add event listener for processor changes
            const processorSelect = item.querySelector('.processor-select');
            const nestedOptions = item.querySelector('.mapping-options:nth-child(2)');
            const typeOptions = item.querySelector('.mapping-options:nth-child(3)');
            
            processorSelect.addEventListener('change', function() {
                const processor = this.value;
                if (nestedOptions) {
                    nestedOptions.style.display = processor === 'extract_nested' ? 'block' : 'none';
                }
                if (typeOptions) {
                    typeOptions.style.display = (processor === 'extract_components' || processor === 'extract_versions') ? 'block' : 'none';
                }
            });
        }

        function resetAllSettings() {
            showConfirm('確定要重設所有設定為預設值嗎？此操作無法復原。', '確認重設所有設定', async () => {
                try {
                    await loadSystemSettings();
                    showToast('所有設定已重設為目前配置值', 'success', '重設完成');
                } catch (error) {
                    showToast('重設設定失敗', 'error', '重設失敗');
                }
            });
        }

        // 頁面載入時應用主題
        loadTheme();

        // 展開所有團隊選單的函數（配置載入後調用）
        function expandAllTeams() {
            Object.keys(globalTeamsConfig).forEach(teamName => {
                toggleTeamMenu(teamName);
            });
        }
        
        // 自動狀態更新
        let statusUpdateInterval;
        
        function startStatusUpdates() {
            // 立即載入一次狀態
            loadSystemStatus();
            
            // 每 30 秒更新一次狀態
            statusUpdateInterval = setInterval(() => {
                loadSystemStatus();
            }, 30000);
        }
        
        function stopStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }
        
        // 使用表單資料測試 JIRA 連線
        async function testJiraConnectionWithFormData() {
            showToast('測試中...', 'info', '連線測試');
            
            try {
                // 收集表單中的 JIRA 設定（密碼從配置檔讀取）
                const jiraConfig = {
                    server_url: document.getElementById('jiraServerUrl').value,
                    username: document.getElementById('jiraUsername').value
                    // 密碼將從後端配置檔中讀取
                };
                
                const result = await fetch('/api/test/jira', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jiraConfig)
                });
                
                const data = await result.json();
                
                if (data.status === 'success') {
                    let message = 'JIRA 連線測試成功！';
                    if (data.server_info) {
                        message += `\n伺服器版本: ${data.server_info.version || 'N/A'}`;
                        message += `\n標題: ${data.server_info.server_title || 'N/A'}`;
                    }
                    showToast(message, 'success', '連線測試');
                    console.log('JIRA 伺服器資訊:', data.server_info);
                } else {
                    showToast(data.message || 'JIRA 連線測試失敗', 'error', '連線測試');
                }
            } catch (error) {
                console.error('JIRA 連線測試錯誤:', error);
                showToast('JIRA 連線失敗', 'error', '連線測試');
            }
        }
        
        // 使用表單資料測試 Lark Base 連線
        async function testLarkConnectionWithFormData() {
            showToast('測試中...', 'info', '連線測試');
            
            try {
                // 收集表單中的 Lark Base 設定（app_secret 從配置檔讀取）
                const larkConfig = {
                    app_id: document.getElementById('larkAppId').value,
                    base_url: document.getElementById('larkBaseUrl').value
                    // app_secret 將從後端配置檔中讀取
                };
                
                const result = await fetch('/api/test/lark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(larkConfig)
                });
                
                const data = await result.json();
                
                if (data.status === 'success') {
                    let message = 'Lark Base 連線測試成功！';
                    if (data.details) {
                        message += `\nWiki Token: ${data.details.wiki_token}`;
                        message += `\n租戶 Token: ${data.details.tenant_token_available ? '✓' : '✗'}`;
                        message += `\nObj Token: ${data.details.obj_token_available ? '✓' : '✗'}`;
                        if (data.details.test_table_id) {
                            message += `\n測試表格: ${data.details.test_table_id}`;
                        }
                    }
                    showToast(message, 'success', '連線測試');
                    console.log('Lark Base 連線詳情:', data.details);
                } else {
                    showToast(data.message || 'Lark Base 連線測試失敗', 'error', '連線測試');
                }
            } catch (error) {
                console.error('Lark Base 連線測試錯誤:', error);
                showToast('Lark 連線失敗', 'error', '連線測試');
            }
        }

        // 更新連線測試函數使用真實 API
        async function testJiraConnection() {
            showToast('測試中...', 'info', '連線測試');
            
            try {
                const result = await apiCall('/api/test/jira', 'GET');
                
                if (result.status === 'success') {
                    let message = 'JIRA 連線測試成功！';
                    if (result.server_info) {
                        message += `\n伺服器版本: ${result.server_info.version || 'N/A'}`;
                        message += `\n標題: ${result.server_info.server_title || 'N/A'}`;
                    }
                    showToast(message, 'success', '連線測試');
                    console.log('JIRA 伺服器資訊:', result.server_info);
                } else {
                    showToast(result.message || 'JIRA 連線測試失敗', 'error', '連線測試');
                }
            } catch (error) {
                console.error('JIRA 連線測試錯誤:', error);
                showToast('JIRA 連線失敗', 'error', '連線測試');
            }
        }
        
        async function testLarkConnection() {
            showToast('測試中...', 'info', '連線測試');
            
            try {
                const result = await apiCall('/api/test/lark', 'POST', {});
                
                if (result.status === 'success') {
                    let message = 'Lark Base 連線測試成功！';
                    if (result.details) {
                        message += `\nWiki Token: ${result.details.wiki_token}`;
                        message += `\n租戶 Token: ${result.details.tenant_token_available ? '✓' : '✗'}`;
                        message += `\nObj Token: ${result.details.obj_token_available ? '✓' : '✗'}`;
                        if (result.details.test_table_id) {
                            message += `\n測試表格: ${result.details.test_table_id}`;
                        }
                    }
                    showToast(message, 'success', '連線測試');
                    console.log('Lark Base 連線詳情:', result.details);
                } else {
                    showToast(result.message || 'Lark Base 連線測試失敗', 'error', '連線測試');
                }
            } catch (error) {
                console.error('Lark Base 連線測試錯誤:', error);
                showToast('Lark 連線失敗', 'error', '連線測試');
            }
        }
        
        async function testAllConnections() {
            showToast('測試中...', 'info', '全面測試');
            
            try {
                const [jiraResult, larkResult] = await Promise.all([
                    apiCall('/api/test/jira', 'GET'),
                    apiCall('/api/test/lark', 'POST', {})
                ]);
                
                let results = [];
                
                if (jiraResult.status === 'success') {
                    results.push('✓ JIRA 連線正常');
                    if (jiraResult.server_info && jiraResult.server_info.version) {
                        results.push(`  版本: ${jiraResult.server_info.version}`);
                    }
                } else {
                    results.push('✗ JIRA 連線失敗');
                    results.push(`  錯誤: ${jiraResult.message || '未知錯誤'}`);
                }
                
                if (larkResult.status === 'success') {
                    results.push('✓ Lark Base 連線正常');
                    if (larkResult.details) {
                        results.push(`  Token 狀態: ${larkResult.details.tenant_token_available ? '正常' : '異常'}`);
                    }
                } else {
                    results.push('✗ Lark Base 連線失敗');
                    results.push(`  錯誤: ${larkResult.message || '未知錯誤'}`);
                }
                
                const allSuccess = jiraResult.status === 'success' && larkResult.status === 'success';
                const message = results.join('\n');
                
                showToast(message, allSuccess ? 'success' : 'warning', '全面測試');
                console.log('連線測試結果:', { jiraResult, larkResult });
                
            } catch (error) {
                console.error('連線測試錯誤:', error);
                showToast('測試失敗', 'error', '全面測試');
            }
        }
        
        // 頁面可見性變更時控制狀態更新和版本檢查
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopStatusUpdates();
                stopConfigVersionCheck();
            } else {
                startStatusUpdates();
                startConfigVersionCheck();
            }
        });
        
        // 頁面卸載時清理資源
        window.addEventListener('beforeunload', () => {
            stopStatusUpdates();
            stopConfigVersionCheck();
        });
        
        // 表格設定相關函數
        let currentTableConfig = null;
        
        async function showTableSettings(teamName, tableName) {
            try {
                // 載入表格配置
                const response = await apiCall(`/api/config/table/${teamName}/${tableName}`, 'GET');
                
                if (response.status === 'success') {
                    currentTableConfig = response.config;
                    
                    // 更新麵包屑和標題
                    document.getElementById('current-table-name').textContent = currentTableConfig.table_config.name || tableName;
                    document.getElementById('table-title').textContent = currentTableConfig.table_config.name || tableName;
                    document.getElementById('team-name').textContent = `${teamName}`;
                    
                    // 填充表格設定表單
                    populateTableSettings(currentTableConfig);
                    
                    // 顯示表格設定頁面
                    showContent('table-settings');
                } else {
                    showToast(response.message || '載入表格配置失敗', 'error', '載入配置');
                }
            } catch (error) {
                console.error('載入表格設定錯誤:', error);
                showToast('載入表格設定失敗', 'error', '載入配置');
            }
        }
        
        function populateTableSettings(config) {
            const { table_config, team_config } = config;
            
            // 基本設定
            document.getElementById('tableName').value = table_config.name || '';
            document.getElementById('tableId').value = table_config.table_id || '';
            document.getElementById('jqlQuery').value = table_config.jql_query || '';
            
            // 同步間隔 - 使用表格特定間隔或團隊間隔
            const syncInterval = table_config.sync_interval || team_config.sync_interval || 300;
            document.getElementById('syncInterval').value = syncInterval;
            
            // 切換開關設定
            const dryRunToggle = document.getElementById('dryRun');
            const masterToggle = document.getElementById('masterToggle');
            const tableStatus = document.getElementById('tableStatus');
            
            // Dry Run 模式
            if (table_config.dry_run) {
                dryRunToggle.classList.add('active');
            } else {
                dryRunToggle.classList.remove('active');
            }
            
            // 啟用狀態
            if (table_config.enabled) {
                masterToggle.classList.add('active');
                tableStatus.innerHTML = '<span>●</span><span>啟用</span>';
            } else {
                masterToggle.classList.remove('active');
                tableStatus.innerHTML = '<span>●</span><span>停用</span>';
            }
        }
        
        function toggleSetting(settingName) {
            const toggle = document.getElementById(settingName);
            toggle.classList.toggle('active');
        }
        
        function toggleTableStatus() {
            const masterToggle = document.getElementById('masterToggle');
            const tableStatus = document.getElementById('tableStatus');
            
            masterToggle.classList.toggle('active');
            
            if (masterToggle.classList.contains('active')) {
                tableStatus.innerHTML = '<span>●</span><span>啟用</span>';
            } else {
                tableStatus.innerHTML = '<span>●</span><span>停用</span>';
            }
        }
        
        async function saveTableSettings() {
            if (!currentTableConfig) {
                showToast('沒有載入的配置資料', 'error', '儲存配置');
                return;
            }
            
            try {
                showToast('正在儲存表格設定...', 'info', '儲存配置');
                
                // 收集表單資料
                const tableConfig = {
                    name: document.getElementById('tableName').value,
                    table_id: document.getElementById('tableId').value,
                    jql_query: document.getElementById('jqlQuery').value,
                    enabled: document.getElementById('masterToggle').classList.contains('active'),
                    dry_run: document.getElementById('dryRun').classList.contains('active'),
                    sync_interval: parseInt(document.getElementById('syncInterval').value)
                };
                
                const teamConfig = {};
                
                // 發送更新請求 - 使用安全API調用
                const response = await safeApiCall(`/api/config/table/${currentTableConfig.team_name}/${currentTableConfig.table_name}`, 'POST', {
                    table_config: tableConfig,
                    team_config: teamConfig
                });
                
                if (!response) {
                    // 版本衝突被處理，使用者選擇重新載入
                    return;
                }
                
                if (response.status === 'success') {
                    showToast('表格設定已成功儲存', 'success', '儲存配置');
                    // 重新載入團隊配置以反映變更
                    await loadTeamsConfig();
                } else {
                    showToast(response.message || '儲存表格設定失敗', 'error', '儲存配置');
                }
            } catch (error) {
                console.error('儲存表格設定錯誤:', error);
                showToast('儲存表格設定失敗', 'error', '儲存配置');
            }
        }
        
        async function syncTable() {
            if (!currentTableConfig) {
                showToast('沒有載入的配置資料', 'error', '同步表格');
                return;
            }
            
            try {
                showToast('正在同步表格...', 'info', '同步表格');
                
                const response = await apiCall(`/api/sync/table/${currentTableConfig.team_name}/${currentTableConfig.table_name}`, 'POST');
                
                if (response.status === 'success') {
                    const { result, duration } = response;
                    let message = `表格同步完成 (${duration}s)`;
                    if (result.summary) {
                        message += `\n同步: ${result.summary.total_synced} 筆`;
                        message += `\n錯誤: ${result.summary.total_errors} 筆`;
                    }
                    showToast(message, 'success', '同步表格');
                } else {
                    showToast(response.message || '表格同步失敗', 'error', '同步表格');
                }
            } catch (error) {
                console.error('同步表格錯誤:', error);
                showToast('同步表格失敗', 'error', '同步表格');
            }
        }
        
        async function fullUpdateTable() {
            if (!currentTableConfig) {
                showToast('沒有載入的配置資料', 'error', '全量更新');
                return;
            }
            
            try {
                showToast('正在執行全量更新...', 'info', '全量更新');
                
                const response = await apiCall(`/api/sync/table/${currentTableConfig.team_name}/${currentTableConfig.table_name}`, 'POST', {
                    full_update: true
                });
                
                if (response.status === 'success') {
                    const { result, duration } = response;
                    let message = `全量更新完成 (${duration}s)`;
                    if (result.summary) {
                        message += `\n同步: ${result.summary.total_synced} 筆`;
                        message += `\n錯誤: ${result.summary.total_errors} 筆`;
                    }
                    showToast(message, 'success', '全量更新');
                } else {
                    showToast(response.message || '全量更新失敗', 'error', '全量更新');
                }
            } catch (error) {
                console.error('全量更新錯誤:', error);
                showToast('全量更新失敗', 'error', '全量更新');
            }
        }
        
        async function validateJQL() {
            const jqlQuery = document.getElementById('jqlQuery').value.trim();
            const jqlResult = document.getElementById('jqlResult');
            
            if (!jqlQuery) {
                showToast('請輸入 JQL 查詢語句', 'warning', 'JQL 驗證');
                jqlResult.style.display = 'none';
                return;
            }
            
            try {
                showToast('驗證中...', 'info', 'JQL 驗證');
                jqlResult.style.display = 'none';
                
                const response = await apiCall('/api/jql/validate', 'POST', { jql: jqlQuery });
                
                if (response.status === 'success') {
                    showToast('語法正確', 'success', 'JQL 驗證');
                } else {
                    showToast(`語法錯誤: ${response.message}`, 'error', 'JQL 驗證');
                }
            } catch (error) {
                console.error('JQL 驗證錯誤:', error);
                showToast('驗證失敗', 'error', 'JQL 驗證');
            }
        }
        
        async function testJQLQuery() {
            const jqlQuery = document.getElementById('jqlQuery').value.trim();
            const jqlResult = document.getElementById('jqlResult');
            const queryResults = document.getElementById('queryResults');
            const resultsTableBody = document.getElementById('resultsTableBody');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!jqlQuery) {
                showToast('請輸入 JQL 查詢語句', 'warning', 'JQL 測試');
                queryResults.style.display = 'none';
                jqlResult.style.display = 'none';
                return;
            }
            
            try {
                showToast('測試中...', 'info', 'JQL 測試');
                queryResults.style.display = 'none';
                jqlResult.style.display = 'none';
                
                const response = await apiCall('/api/jql/test', 'POST', { 
                    jql: jqlQuery, 
                    max_results: 10 
                });
                
                if (response.status === 'success') {
                    const { issues, total } = response;
                    
                    // 顯示測試成功訊息
                    showToast(`找到 ${total} 筆記錄`, 'success', 'JQL 測試');
                    
                    // 更新結果計數
                    resultsCount.textContent = `${issues.length} 筆記錄 (總計: ${total})`;
                    
                    // 清空並填充結果表格
                    resultsTableBody.innerHTML = '';
                    
                    issues.forEach(issue => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="${issue.url}" target="_blank">${issue.key}</a></td>
                            <td>${issue.summary || 'N/A'}</td>
                            <td>${issue.status || 'N/A'}</td>
                            <td>${issue.assignee || 'Unassigned'}</td>
                        `;
                        resultsTableBody.appendChild(row);
                    });
                    
                    // 顯示結果表格
                    queryResults.style.display = 'block';
                } else {
                    showToast(response.message || '查詢失敗', 'error', 'JQL 測試');
                    queryResults.style.display = 'none';
                }
            } catch (error) {
                console.error('JQL 測試錯誤:', error);
                showToast('測試失敗', 'error', 'JQL 測試');
                queryResults.style.display = 'none';
            }
        }
        
        function showJQLExamples() {
            const examples = [
                'project = TP AND status = "In Progress"',
                'project = TCG AND updated >= -7d',
                'assignee = currentUser() AND status != Closed',
                'component in (CRM, Payment) AND priority = High',
                'fixVersion in unreleasedVersions() ORDER BY created DESC'
            ];
            
            const exampleText = examples.join('\n');
            showToast(`JQL 查詢範例:\n${exampleText}`, 'info', 'JQL 範例');
        }
        
        // 團隊設定相關函數
        let currentTeamConfig = null;
        
        async function showTeamSettings(teamName) {
            try {
                // 載入團隊配置
                const response = await apiCall(`/api/config/team/${teamName}`, 'GET');
                
                if (response.status === 'success') {
                    currentTeamConfig = response.config;
                    
                    // 更新頁面標題和麵包屑
                    const teamDisplayName = currentTeamConfig.display_name || teamName.toUpperCase();
                    document.getElementById('current-team-breadcrumb').textContent = teamDisplayName;
                    document.getElementById('team-settings-title').textContent = teamDisplayName + ' 設定';
                    
                    // 填充團隊設定表單
                    populateTeamSettings(currentTeamConfig, teamName);
                    
                    // 顯示團隊設定頁面
                    showContent('team-settings');
                } else {
                    showToast(response.message || '載入團隊配置失敗', 'error', '載入配置');
                }
            } catch (error) {
                console.error('載入團隊設定錯誤:', error);
                showToast('載入團隊設定失敗', 'error', '載入配置');
            }
        }
        
        function populateTeamSettings(config, teamName) {
            // 基本設定
            document.getElementById('teamDisplayName').value = config.display_name || teamName.toUpperCase();
            document.getElementById('teamWikiToken').value = config.wiki_token || '';
            document.getElementById('teamPollInterval').value = config.sync_interval || 300;
            
            // 更新表格數量
            const tablesCount = Object.keys(config.tables || {}).length;
            document.getElementById('team-tables-count').textContent = `${tablesCount} 個表格`;
            
            // 載入表格列表
            loadTablesList(config.tables || {}, teamName);
        }
        
        function loadTablesList(tables, teamName) {
            const tablesList = document.getElementById('tables-list');
            tablesList.innerHTML = '';
            
            Object.keys(tables).forEach(tableName => {
                const tableConfig = tables[tableName];
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                
                const statusClass = tableConfig.enabled ? 'enabled' : 'disabled';
                const statusText = tableConfig.enabled ? '啟用' : '停用';
                const statusIcon = tableConfig.enabled ? '●' : '○';
                
                tableItem.innerHTML = `
                    <div class="table-item-header">
                        <div class="table-item-title">${tableConfig.name || tableName}</div>
                        <div class="table-item-status ${statusClass}">
                            <span>${statusIcon}</span>
                            <span>${statusText}</span>
                        </div>
                    </div>
                    <div class="table-item-info">
                        <div>Table ID: ${tableConfig.table_id || 'N/A'}</div>
                        <div>Dry Run: ${tableConfig.dry_run ? '是' : '否'}</div>
                    </div>
                    <div class="table-item-actions">
                        <button class="table-btn primary" onclick="editTable('${teamName}', '${tableName}')">編輯設定</button>
                        <button class="table-btn" onclick="syncSingleTable('${teamName}', '${tableName}')">同步表格</button>
                        <button class="table-btn" onclick="toggleTableEnabled('${teamName}', '${tableName}', ${tableConfig.enabled})">${tableConfig.enabled ? '停用' : '啟用'}</button>
                        <button class="table-btn" onclick="deleteTable('${teamName}', '${tableName}')">刪除</button>
                    </div>
                `;
                
                tablesList.appendChild(tableItem);
            });
        }
        
        function editTable(teamName, tableName) {
            showContent('table-settings', teamName, tableName);
        }
        
        async function syncSingleTable(teamName, tableName) {
            try {
                showToast(`正在同步表格 ${tableName}...`, 'info', '同步表格');
                
                const response = await apiCall(`/api/sync/table/${teamName}/${tableName}`, 'POST');
                
                if (response.status === 'success') {
                    showToast(`表格 ${tableName} 同步完成`, 'success', '同步表格');
                } else {
                    showToast(response.message || '表格同步失敗', 'error', '同步表格');
                }
            } catch (error) {
                console.error('同步表格錯誤:', error);
                showToast('同步表格失敗', 'error', '同步表格');
            }
        }
        
        async function toggleTableEnabled(teamName, tableName, currentEnabled) {
            try {
                const newEnabled = !currentEnabled;
                const action = newEnabled ? '啟用' : '停用';
                
                showToast(`正在${action}表格 ${tableName}...`, 'info', '修改狀態');
                
                // 獲取當前表格配置
                const response = await apiCall(`/api/config/table/${teamName}/${tableName}`, 'GET');
                if (response.status !== 'success') {
                    throw new Error('無法載入表格配置');
                }
                
                // 更新啟用狀態
                const updatedConfig = response.config.table_config;
                updatedConfig.enabled = newEnabled;
                
                const updateResponse = await safeApiCall(`/api/config/table/${teamName}/${tableName}`, 'POST', {
                    table_config: updatedConfig
                });
                
                if (!updateResponse) {
                    // 版本衝突被處理，使用者選擇重新載入
                    return;
                }
                
                if (updateResponse.status === 'success') {
                    showToast(`表格 ${tableName} 已${action}`, 'success', '修改狀態');
                    // 重新載入頁面以反映變更
                    showTeamSettings(teamName);
                    // 重新載入側邊欄
                    await loadTeamsConfig();
                } else {
                    showToast(updateResponse.message || `${action}表格失敗`, 'error', '修改狀態');
                }
            } catch (error) {
                console.error('修改表格狀態錯誤:', error);
                showToast('修改表格狀態失敗', 'error', '修改狀態');
            }
        }
        
        async function deleteTable(teamName, tableName) {
            showConfirm(
                `確定要刪除表格 "${tableName}" 嗎？此操作無法復原。`,
                '確認刪除表格',
                async () => {
                    try {
                        showToast(`正在刪除表格 ${tableName}...`, 'info', '刪除表格');
                        
                        const response = await apiCall(`/api/config/table/${teamName}/${tableName}`, 'DELETE');
                        
                        if (response.status === 'success') {
                            showToast(`表格 ${tableName} 已刪除`, 'success', '刪除表格');
                            // 重新載入頁面
                            showTeamSettings(teamName);
                            // 重新載入側邊欄
                            await loadTeamsConfig();
                        } else {
                            showToast(response.message || '刪除表格失敗', 'error', '刪除表格');
                        }
                    } catch (error) {
                        console.error('刪除表格錯誤:', error);
                        showToast('刪除表格失敗', 'error', '刪除表格');
                    }
                }
            );
        }
        
        function addNewTable() {
            if (!currentTeamConfig) {
                showToast('沒有載入的配置資料', 'error', '新增表格');
                return;
            }
            
            showAddTableDialog();
        }
        
        function showAddTableDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.display = 'flex';
            
            overlay.innerHTML = `
                <div class="modal" style="width: 480px;">
                    <div class="modal-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        新增表格
                    </div>
                    <div class="modal-content">
                        <div class="setting-item">
                            <label class="setting-label">表格名稱 (系統內部使用)</label>
                            <input type="text" class="setting-input" id="newTableName" placeholder="例如: new_table (英文，無空格)">
                            <div class="setting-help">系統內部識別用的表格名稱，只能使用英文字母、數字和底線</div>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">表格顯示名稱</label>
                            <input type="text" class="setting-input" id="newTableDisplayName" placeholder="例如: 新專案任務表">
                            <div class="setting-help">在介面中顯示的表格名稱</div>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">Lark Base Table ID</label>
                            <input type="text" class="setting-input" id="newTableId" placeholder="例如: tblSaaIG0auAVR7k">
                            <div class="setting-help">從 Lark Base 中取得的表格 ID</div>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">JQL 查詢語句</label>
                            <textarea class="setting-input" id="newTableJQL" rows="3" placeholder="project = PROJECT AND status in (Open, &quot;In Progress&quot;) ORDER BY updated DESC">${`project = ${currentTeamConfig.name ? currentTeamConfig.name.toUpperCase() : 'PROJECT'} AND status in (Open, "In Progress") ORDER BY updated DESC`}</textarea>
                            <div class="setting-help">JIRA 查詢語句，定義要同步的 Issues</div>
                        </div>
                        
                        <div class="toggle-row">
                            <div class="toggle-item">
                                <div class="toggle-switch active" id="newTableEnabled">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span>啟用表格</span>
                            </div>
                            <div class="toggle-item">
                                <div class="toggle-switch" id="newTableDryRun">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span>乾跑模式</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn secondary" onclick="closeAddTableDialog()">取消</button>
                        <button class="modal-btn primary" onclick="confirmAddTable()">新增表格</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // 設置切換開關事件
            overlay.querySelector('#newTableEnabled').addEventListener('click', function() {
                this.classList.toggle('active');
            });
            
            overlay.querySelector('#newTableDryRun').addEventListener('click', function() {
                this.classList.toggle('active');
            });
            
            // 聚焦到第一個輸入框
            setTimeout(() => {
                overlay.querySelector('#newTableName').focus();
            }, 100);
        }
        
        function closeAddTableDialog() {
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function confirmAddTable() {
            const tableName = document.getElementById('newTableName').value.trim();
            const tableDisplayName = document.getElementById('newTableDisplayName').value.trim();
            const tableId = document.getElementById('newTableId').value.trim();
            const jqlQuery = document.getElementById('newTableJQL').value.trim();
            const enabled = document.getElementById('newTableEnabled').classList.contains('active');
            const dryRun = document.getElementById('newTableDryRun').classList.contains('active');
            
            // 驗證必填欄位
            if (!tableName) {
                showToast('請輸入表格名稱', 'error', '欄位驗證');
                return;
            }
            
            if (!tableDisplayName) {
                showToast('請輸入表格顯示名稱', 'error', '欄位驗證');
                return;
            }
            
            if (!tableId) {
                showToast('請輸入 Lark Base Table ID', 'error', '欄位驗證');
                return;
            }
            
            if (!jqlQuery) {
                showToast('請輸入 JQL 查詢語句', 'error', '欄位驗證');
                return;
            }
            
            // 驗證表格名稱格式 (只允許英文、數字、底線)
            if (!/^[a-zA-Z0-9_]+$/.test(tableName)) {
                showToast('表格名稱只能包含英文字母、數字和底線', 'error', '格式驗證');
                return;
            }
            
            // 檢查表格名稱是否已存在
            if (currentTeamConfig.tables && currentTeamConfig.tables[tableName]) {
                showToast('表格名稱已存在，請使用其他名稱', 'error', '名稱衝突');
                return;
            }
            
            // 創建新表格配置
            const newTableConfig = {
                name: tableDisplayName,
                table_id: tableId,
                enabled: enabled,
                dry_run: dryRun,
                jql_query: jqlQuery
            };
            
            // 關閉對話框
            closeAddTableDialog();
            
            // 保存新表格
            saveNewTable(currentTeamConfig.name, tableName, newTableConfig);
        }
        
        async function saveNewTable(teamName, tableName, tableConfig) {
            try {
                showToast(`正在新增表格 ${tableName}...`, 'info', '新增表格');
                
                const response = await safeApiCall(`/api/config/table/${teamName}/${tableName}`, 'POST', {
                    table_config: tableConfig
                });
                
                if (!response) {
                    // 版本衝突被處理，使用者選擇重新載入
                    return;
                }
                
                if (response.status === 'success') {
                    showToast(`表格 ${tableName} 已新增`, 'success', '新增表格');
                    // 重新載入頁面
                    showTeamSettings(teamName);
                    // 重新載入側邊欄
                    await loadTeamsConfig();
                } else {
                    showToast(response.message || '新增表格失敗', 'error', '新增表格');
                }
            } catch (error) {
                console.error('新增表格錯誤:', error);
                showToast('新增表格失敗', 'error', '新增表格');
            }
        }
        
        async function saveTeamSettings() {
            if (!currentTeamConfig) {
                showToast('沒有載入的配置資料', 'error', '儲存配置');
                return;
            }
            
            try {
                showToast('正在儲存團隊設定...', 'info', '儲存配置');
                
                // 收集表單資料
                const teamConfig = {
                    display_name: document.getElementById('teamDisplayName').value,
                    wiki_token: document.getElementById('teamWikiToken').value,
                    sync_interval: parseInt(document.getElementById('teamPollInterval').value)
                };
                
                // 發送更新請求 - 使用安全API調用
                const response = await safeApiCall(`/api/config/team/${currentTeamConfig.name}`, 'POST', teamConfig);
                
                if (!response) {
                    // 版本衝突被處理，使用者選擇重新載入
                    return;
                }
                
                if (response.status === 'success') {
                    showToast('團隊設定已成功儲存', 'success', '儲存配置');
                    // 重新載入團隊配置以反映變更
                    await loadTeamsConfig();
                } else {
                    showToast(response.message || '儲存團隊設定失敗', 'error', '儲存配置');
                }
            } catch (error) {
                console.error('儲存團隊設定錯誤:', error);
                showToast('儲存團隊設定失敗', 'error', '儲存配置');
            }
        }
        
        async function syncTeam() {
            if (!currentTeamConfig) {
                showToast('沒有載入的配置資料', 'error', '同步團隊');
                return;
            }
            
            try {
                showToast('正在同步團隊...', 'info', '同步團隊');
                
                const response = await apiCall(`/api/sync/team/${currentTeamConfig.name}`, 'POST');
                
                if (response.status === 'success') {
                    showToast('團隊同步完成', 'success', '同步團隊');
                } else {
                    showToast(response.message || '團隊同步失敗', 'error', '同步團隊');
                }
            } catch (error) {
                console.error('同步團隊錯誤:', error);
                showToast('同步團隊失敗', 'error', '同步團隊');
            }
        }
        
        async function fullUpdateTeam() {
            if (!currentTeamConfig) {
                showToast('沒有載入的配置資料', 'error', '全量更新');
                return;
            }
            
            try {
                showToast('正在執行團隊全量更新...', 'info', '全量更新');
                
                const response = await apiCall(`/api/sync/team/${currentTeamConfig.name}`, 'POST', {
                    full_update: true
                });
                
                if (response.status === 'success') {
                    showToast('團隊全量更新完成', 'success', '全量更新');
                } else {
                    showToast(response.message || '團隊全量更新失敗', 'error', '全量更新');
                }
            } catch (error) {
                console.error('團隊全量更新錯誤:', error);
                showToast('團隊全量更新失敗', 'error', '全量更新');
            }
        }
        
        function toggleTeamStatus() {
            const masterToggle = document.getElementById('teamMasterToggle');
            const teamStatus = document.getElementById('teamStatusIndicator');
            
            masterToggle.classList.toggle('active');
            
            if (masterToggle.classList.contains('active')) {
                teamStatus.innerHTML = '<span>●</span><span>執行中</span>';
            } else {
                teamStatus.innerHTML = '<span>●</span><span>停用</span>';
            }
        }
        
        async function testTeamConnection() {
            if (!currentTeamConfig) {
                showToast('沒有載入的配置資料', 'error', '測試連線');
                return;
            }
            
            try {
                showToast('測試中...', 'info', '測試連線');
                
                const response = await apiCall('/api/test/lark', 'POST', {
                    wiki_token: document.getElementById('teamWikiToken').value
                });
                
                if (response.status === 'success') {
                    showToast('團隊連線測試成功', 'success', '測試連線');
                } else {
                    showToast(response.message || '團隊連線測試失敗', 'error', '測試連線');
                }
            } catch (error) {
                console.error('測試連線錯誤:', error);
                showToast('測試連線失敗', 'error', '測試連線');
            }
        }
        
        // 配置檔案編輯功能
        function editConfigFile() {
            showConfirm(
                '⚠️ 警告：直接編輯配置檔案需要謹慎操作！<br><br>' +
                '• 語法錯誤可能導致系統無法啟動<br>' +
                '• 修改前會自動建立備份檔案<br>' +
                '• 儲存前會驗證 YAML 語法<br>' +
                '• 建議只有熟悉 YAML 格式的用戶操作<br><br>' +
                '您確定要繼續嗎？',
                '警告 - 直接編輯配置檔案',
                openConfigEditor
            );
        }
        
        async function openConfigEditor() {
            try {
                // 取得原始配置檔案內容
                const response = await apiCall('/api/config/raw', 'GET');
                
                if (response.status === 'success') {
                    // 建立配置編輯器模態視窗
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.style.display = 'flex';
                    
                    overlay.innerHTML = `
                        <div class="modal" style="width: 90%; max-width: 1200px; height: 80vh; max-height: 800px;">
                            <div class="modal-title">
                                <span>配置檔案編輯器</span>
                                <button class="modal-close" onclick="closeConfigEditor(this)">×</button>
                            </div>
                            <div style="padding: 20px; display: flex; flex-direction: column; height: calc(100% - 60px);">
                                <div style="margin-bottom: 15px; font-size: 14px; color: #888;">
                                    檔案路徑: ${response.file_path}
                                </div>
                                <textarea id="configContent" style="
                                    flex: 1;
                                    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    padding: 15px;
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 8px;
                                    background: rgba(0, 0, 0, 0.3);
                                    color: #ffffff;
                                    resize: none;
                                    outline: none;
                                    white-space: pre;
                                    overflow-wrap: normal;
                                    overflow-x: auto;
                                ">${response.content}</textarea>
                                <div class="modal-actions" style="margin-top: 15px;">
                                    <button class="modal-btn secondary" onclick="closeConfigEditor(this)">取消</button>
                                    <button class="modal-btn primary" onclick="saveConfigFile(this)">儲存配置</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    
                    // 自動調整 textarea 高度
                    const textarea = document.getElementById('configContent');
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                    
                    // 聚焦到編輯器
                    textarea.focus();
                    
                } else {
                    showToast(response.message || '載入配置檔案失敗', 'error', '載入配置');
                }
            } catch (error) {
                console.error('開啟配置編輯器錯誤:', error);
                showToast('開啟配置編輯器失敗', 'error', '載入配置');
            }
        }
        
        async function saveConfigFile(button) {
            const content = document.getElementById('configContent').value;
            
            if (!content.trim()) {
                showToast('配置內容不能為空', 'error', '儲存配置');
                return;
            }
            
            try {
                showToast('驗證和儲存配置檔案中...', 'info', '儲存配置');
                
                const response = await safeApiCall('/api/config/raw', 'POST', {
                    content: content
                });
                
                if (!response) {
                    // 版本衝突被處理，使用者選擇重新載入
                    return;
                }
                
                if (response.status === 'success') {
                    showToast('配置檔案儲存成功', 'success', '儲存配置');
                    closeConfigEditor(button);
                    
                    // 重新載入頁面以反映配置變更
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(response.message || '配置檔案儲存失敗', 'error', '儲存配置');
                }
            } catch (error) {
                console.error('儲存配置檔案錯誤:', error);
                showToast('儲存配置檔案失敗', 'error', '儲存配置');
            }
        }
        
        function closeConfigEditor(button) {
            const overlay = button.closest('.modal-overlay');
            overlay.remove();
        }
        
        // 日誌查看功能
        async function showLogViewer() {
            try {
                showToast('載入日誌中...', 'info', '日誌查看');
                
                // 取得日誌內容
                const response = await apiCall('/api/logs?lines=1000', 'GET');
                
                if (response.status === 'success') {
                    // 建立日誌查看器模態視窗
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.style.display = 'flex';
                    
                    const fileSize = response.file_size ? `${(response.file_size / 1024).toFixed(1)} KB` : 'N/A';
                    
                    overlay.innerHTML = `
                        <div class="modal" style="width: 95%; max-width: 1400px; height: 85vh; max-height: 900px;">
                            <div class="modal-title">
                                <span>系統日誌查看器</span>
                                <button class="modal-close" onclick="closeLogViewer(this)">×</button>
                            </div>
                            <div style="padding: 20px; display: flex; flex-direction: column; height: calc(100% - 60px);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div id="fileInfoDisplay" style="font-size: 14px; color: #888;">
                                        檔案: ${response.file_path} | 總行數: ${response.total_lines} | 檔案大小: ${fileSize}
                                    </div>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="logLinesSelect" style="
                                            background: rgba(0, 0, 0, 0.3);
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 6px;
                                            color: #ffffff;
                                            padding: 6px 12px;
                                            font-size: 14px;
                                        ">
                                            <option value="100">最後 100 行</option>
                                            <option value="500">最後 500 行</option>
                                            <option value="1000" selected>最後 1000 行</option>
                                            <option value="5000">最後 5000 行</option>
                                            <option value="0">全部</option>
                                        </select>
                                        <button class="modal-btn secondary" type="button" id="refreshLogsBtn">刷新</button>
                                    </div>
                                </div>
                                <div style="
                                    flex: 1;
                                    background: rgba(0, 0, 0, 0.5);
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 8px;
                                    padding: 15px;
                                    overflow: auto;
                                    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                                    font-size: 13px;
                                    line-height: 1.4;
                                    white-space: pre-wrap;
                                    word-wrap: break-word;
                                ">
                                    <div id="logContent" style="color: #e0e0e0;">${response.content || '日誌檔案為空'}</div>
                                </div>
                                <div class="modal-actions" style="margin-top: 15px;">
                                    <button class="modal-btn secondary" onclick="closeLogViewer(this)">關閉</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    
                    // 添加刷新按鈕的事件監聽器
                    const refreshBtn = document.getElementById('refreshLogsBtn');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            refreshLogs();
                        });
                    }
                    
                    // 自動滾動到底部
                    const logContent = document.getElementById('logContent');
                    logContent.scrollTop = logContent.scrollHeight;
                    
                } else {
                    showToast(response.message || '載入日誌失敗', 'error', '日誌查看');
                }
            } catch (error) {
                console.error('載入日誌錯誤:', error);
                showToast('載入日誌失敗', 'error', '日誌查看');
            }
        }
        
        async function refreshLogs() {
            const selectedLines = document.getElementById('logLinesSelect').value;
            
            try {
                showToast('刷新日誌中...', 'info', '日誌查看');
                
                const response = await apiCall(`/api/logs?lines=${selectedLines}`, 'GET');
                
                if (response.status === 'success') {
                    const logContent = document.getElementById('logContent');
                    logContent.textContent = response.content || '日誌檔案為空';
                    
                    // 更新檔案資訊
                    const fileSize = response.file_size ? `${(response.file_size / 1024).toFixed(1)} KB` : 'N/A';
                    const fileInfo = document.getElementById('fileInfoDisplay');
                    if (fileInfo) {
                        fileInfo.textContent = `檔案: ${response.file_path} | 總行數: ${response.total_lines} | 檔案大小: ${fileSize}`;
                    }
                    
                    // 自動滾動到底部
                    logContent.scrollTop = logContent.scrollHeight;
                    
                    showToast('日誌刷新完成', 'success', '日誌查看');
                } else {
                    showToast(response.message || '刷新日誌失敗', 'error', '日誌查看');
                }
            } catch (error) {
                console.error('刷新日誌錯誤:', error);
                showToast('刷新日誌失敗', 'error', '日誌查看');
            }
        }
        
        function closeLogViewer(button) {
            const overlay = button.closest('.modal-overlay');
            overlay.remove();
        }
        
        // 初始化函數
        async function initializeApp() {
            // 載入配置版本管理
            await loadConfigVersion();
            
            // 開始配置版本檢查
            startConfigVersionCheck();
            
            // 載入團隊配置並生成側邊欄
            await loadTeamsConfig();
            
            // 展開所有團隊選單
            expandAllTeams();
            
            // 初始化 - 預設顯示 dashboard
            showContent('dashboard');
            
            // 開始自動狀態更新
            startStatusUpdates();
        }
        
        
        // Smart Field Wizard Functions
        let smartWizardStep = 1;
        let currentTicketData = null;
        let selectedFieldData = null;
        let fieldCategories = [];
        
        function openSmartFieldWizard() {
            const wizard = document.getElementById('smartFieldWizard');
            wizard.style.display = 'block';
            
            resetSmartWizard();
            showToast('智慧新增欄位精靈已啟動', 'info', '精靈');
        }
        
        function closeSmartFieldWizard() {
            const wizard = document.getElementById('smartFieldWizard');
            wizard.style.display = 'none';
            resetSmartWizard();
        }
        
        function resetSmartWizard() {
            smartWizardStep = 1;
            currentTicketData = null;
            selectedFieldData = null;
            
            // 隱藏所有步驟
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`smartStep${i}`).style.display = i === 1 ? 'block' : 'none';
            }
            
            // 重置進度指示器
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelector('[data-step="1"]').classList.add('active');
            
            // 清空表單
            document.getElementById('ticketKeyInput').value = '';
            document.getElementById('ticketInfo').innerHTML = '';
            document.getElementById('fieldsList').innerHTML = '';
            document.getElementById('duplicateCheckResult').innerHTML = '';
            document.getElementById('reviewContent').innerHTML = '';
        }
        
        function goBackToStep(step) {
            smartWizardStep = step;
            
            // 隱藏所有步驟
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`smartStep${i}`).style.display = i === step ? 'block' : 'none';
            }
            
            // 更新進度指示器
            document.querySelectorAll('.progress-step').forEach(stepEl => {
                const stepNum = parseInt(stepEl.dataset.step);
                stepEl.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    stepEl.classList.add('completed');
                } else if (stepNum === step) {
                    stepEl.classList.add('active');
                }
            });
        }
        
        async function fetchTicketFields() {
            const ticketKey = document.getElementById('ticketKeyInput').value.trim();
            
            if (!ticketKey) {
                showToast('請輸入 Ticket 號碼', 'warning', '精靈');
                return;
            }
            
            try {
                showToast('正在取得 Ticket 資料...', 'info', '精靈');
                
                const response = await apiCall(`/api/smart-field/get-issue/${ticketKey}`, 'GET');
                
                if (response.status === 'success') {
                    currentTicketData = response;
                    displayTicketFields(response);
                    goToStep(2);
                    showToast('Ticket 資料取得成功', 'success', '精靈');
                } else {
                    showToast(response.message || 'Ticket 取得失敗', 'error', '精靈');
                }
            } catch (error) {
                console.error('取得 Ticket 錯誤:', error);
                showToast('取得 Ticket 失敗', 'error', '精靈');
            }
        }
        
        function displayTicketFields(ticketData) {
            // 顯示 Ticket 資訊
            const ticketInfo = document.getElementById('ticketInfo');
            ticketInfo.innerHTML = `
                <div><strong>Ticket:</strong> ${ticketData.issue_key}</div>
                <div><strong>標題:</strong> ${ticketData.issue_summary}</div>
                <div><strong>欄位數量:</strong> ${ticketData.total_fields} 個</div>
            `;
            
            // 顯示欄位清單
            const fieldsList = document.getElementById('fieldsList');
            fieldsList.innerHTML = '';
            
            ticketData.fields.forEach(field => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'field-item';
                fieldItem.onclick = () => selectField(field, fieldItem);
                
                const sampleDisplay = field.sample_value ? 
                    (typeof field.sample_value === 'string' ? 
                        field.sample_value.substring(0, 50) + (field.sample_value.length > 50 ? '...' : '') :
                        JSON.stringify(field.sample_value).substring(0, 50) + '...'
                    ) : 'null';
                
                fieldItem.innerHTML = `
                    <div>
                        <div class="field-path">${field.field_path}</div>
                        <div style="font-size: 11px; color: #888; margin-top: 2px;">範例: ${sampleDisplay}</div>
                    </div>
                    <div class="field-type">${field.field_type}</div>
                `;
                
                fieldsList.appendChild(fieldItem);
            });
        }
        
        function selectField(field, element) {
            // 清除之前的選擇
            document.querySelectorAll('.field-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 標記選中
            element.classList.add('selected');
            selectedFieldData = field;
            
            // 顯示繼續按鈕
            document.getElementById('continueToStep3').style.display = 'inline-block';
        }
        
        async function checkFieldExists() {
            if (!selectedFieldData) {
                showToast('請選擇一個欄位', 'warning', '精靈');
                return;
            }
            
            try {
                showToast('檢查欄位是否已存在...', 'info', '精靈');
                
                const response = await apiCall('/api/smart-field/check-existing', 'POST', {
                    field_path: selectedFieldData.field_path
                });
                
                const resultDiv = document.getElementById('duplicateCheckResult');
                
                if (response.status === 'warning' && response.exists) {
                    resultDiv.className = 'check-result warning';
                    resultDiv.innerHTML = `
                        <h6>⚠️ 欄位已存在</h6>
                        <p>${response.message}</p>
                        <p>目前對應到: <strong>${response.current_mapping.lark_field}</strong></p>
                        <p>您可以選擇其他欄位或取消新增。</p>
                    `;
                    
                    document.getElementById('cancelButton').style.display = 'inline-block';
                    document.getElementById('continueToStep4').style.display = 'none';
                } else {
                    resultDiv.className = 'check-result success';
                    resultDiv.innerHTML = `
                        <h6>✅ 欄位可以新增</h6>
                        <p>${response.message}</p>
                        <p>欄位路徑: <strong>${selectedFieldData.field_path}</strong></p>
                    `;
                    
                    document.getElementById('cancelButton').style.display = 'none';
                    document.getElementById('continueToStep4').style.display = 'inline-block';
                }
                
                goToStep(3);
                
            } catch (error) {
                console.error('檢查欄位錯誤:', error);
                showToast('檢查欄位失敗', 'error', '精靈');
            }
        }
        
        async function loadFieldCategories() {
            try {
                showToast('載入欄位分類...', 'info', '精靈');
                
                const response = await apiCall('/api/smart-field/get-field-categories', 'GET');
                
                if (response.status === 'success') {
                    fieldCategories = response.categories;
                    populateFieldCategories();
                    goToStep(4);
                } else {
                    showToast('載入分類失敗', 'error', '精靈');
                }
            } catch (error) {
                console.error('載入分類錯誤:', error);
                showToast('載入分類失敗', 'error', '精靈');
            }
        }
        
        function populateFieldCategories() {
            const select = document.getElementById('fieldCategorySelect');
            select.innerHTML = '<option value="">請選擇欄位分類...</option>';
            
            fieldCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} - ${category.description}`;
                select.appendChild(option);
            });
        }
        
        function onCategoryChange() {
            const categoryId = document.getElementById('fieldCategorySelect').value;
            const category = fieldCategories.find(c => c.id === categoryId);
            
            // 隱藏所有選項
            document.getElementById('nestedFieldOptions').style.display = 'none';
            document.getElementById('arrayFieldOptions').style.display = 'none';
            document.getElementById('continueToStep5').style.display = 'none';
            
            if (!category) return;
            
            // 根據欄位類型顯示相應選項
            if (selectedFieldData.is_nested || category.id === 'nested_fields') {
                showNestedOptions();
            } else if (selectedFieldData.is_array || category.id.startsWith('array_')) {
                showArrayOptions();
            } else {
                // 簡單欄位，直接可以繼續
                document.getElementById('continueToStep5').style.display = 'inline-block';
            }
        }
        
        function showNestedOptions() {
            const optionsDiv = document.getElementById('nestedFieldOptions');
            const select = document.getElementById('nestedPathSelect');
            
            optionsDiv.style.display = 'block';
            select.innerHTML = '<option value="">請選擇路徑...</option>';
            
            if (selectedFieldData.nested_paths) {
                selectedFieldData.nested_paths.forEach(path => {
                    const option = document.createElement('option');
                    option.value = `${selectedFieldData.field_path}.${path}`;
                    option.textContent = `${selectedFieldData.field_path}.${path}`;
                    select.appendChild(option);
                });
            }
            
            select.onchange = () => {
                if (select.value) {
                    selectedFieldData.final_path = select.value;
                    document.getElementById('continueToStep5').style.display = 'inline-block';
                }
            };
        }
        
        function showArrayOptions() {
            const optionsDiv = document.getElementById('arrayFieldOptions');
            const select = document.getElementById('arrayPathSelect');
            
            optionsDiv.style.display = 'block';
            select.innerHTML = '<option value="">請選擇元素...</option>';
            
            if (selectedFieldData.array_item_keys) {
                selectedFieldData.array_item_keys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = `${selectedFieldData.field_path}[0].${key}`;
                    option.textContent = `${selectedFieldData.field_path}[0].${key}`;
                    select.appendChild(option);
                });
            }
            
            select.onchange = () => {
                if (select.value) {
                    selectedFieldData.final_path = select.value;
                    document.getElementById('continueToStep5').style.display = 'inline-block';
                }
            };
        }
        
        function loadLarkFields() {
            // 載入團隊清單
            const teamSelect = document.getElementById('targetTeamSelect');
            teamSelect.innerHTML = '<option value="">請選擇團隊...</option>';
            
            Object.keys(globalTeamsConfig).forEach(teamName => {
                const teamData = globalTeamsConfig[teamName];
                const displayName = teamData.display_name || teamName.toUpperCase();
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = `${displayName}`;
                teamSelect.appendChild(option);
            });
            
            goToStep(5);
        }
        
        function loadTargetTables() {
            const teamName = document.getElementById('targetTeamSelect').value;
            const tableSelect = document.getElementById('targetTableSelect');
            
            tableSelect.innerHTML = '<option value="">請選擇表格...</option>';
            
            if (teamName && globalTeamsConfig[teamName]) {
                const tables = globalTeamsConfig[teamName].tables;
                Object.keys(tables).forEach(tableName => {
                    const tableData = tables[tableName];
                    if (tableData.enabled) {
                        const option = document.createElement('option');
                        option.value = tableName;
                        option.textContent = tableData.name || tableName;
                        tableSelect.appendChild(option);
                    }
                });
            }
        }
        
        async function loadTargetLarkFields() {
            const teamName = document.getElementById('targetTeamSelect').value;
            const tableName = document.getElementById('targetTableSelect').value;
            const fieldSelect = document.getElementById('larkTargetFieldSelect');
            
            if (!teamName || !tableName) {
                fieldSelect.innerHTML = '<option value="">請先選擇團隊和表格...</option>';
                return;
            }
            
            try {
                const response = await apiCall(`/api/lark/table-fields/${teamName}/${tableName}`, 'GET');
                
                if (response.status === 'success') {
                    fieldSelect.innerHTML = '<option value="">請選擇 Lark 欄位...</option>';
                    
                    response.fields.forEach(field => {
                        const option = document.createElement('option');
                        option.value = field;
                        option.textContent = field;
                        fieldSelect.appendChild(option);
                    });
                    
                    fieldSelect.onchange = () => {
                        if (fieldSelect.value) {
                            document.getElementById('continueToStep6').style.display = 'inline-block';
                        }
                    };
                } else {
                    showToast('載入 Lark 欄位失敗', 'error', '精靈');
                }
            } catch (error) {
                console.error('載入 Lark 欄位錯誤:', error);
                showToast('載入欄位失敗', 'error', '精靈');
            }
        }
        
        function showReviewStep() {
            const finalPath = selectedFieldData.final_path || selectedFieldData.field_path;
            const categoryId = document.getElementById('fieldCategorySelect').value;
            const category = fieldCategories.find(c => c.id === categoryId);
            const larkField = document.getElementById('larkTargetFieldSelect').value;
            const teamName = document.getElementById('targetTeamSelect').value;
            const tableName = document.getElementById('targetTableSelect').value;
            
            const reviewContent = document.getElementById('reviewContent');
            reviewContent.innerHTML = `
                <div class="review-item">
                    <span class="review-label">來源 Ticket:</span>
                    <span class="review-value">${currentTicketData.issue_key}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">JIRA 欄位路徑:</span>
                    <span class="review-value">${finalPath}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">欄位分類:</span>
                    <span class="review-value">${category ? category.name : 'N/A'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">處理器:</span>
                    <span class="review-value">${category ? category.processor : 'extract_simple'}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">目標團隊:</span>
                    <span class="review-value">${teamName}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">目標表格:</span>
                    <span class="review-value">${tableName}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Lark 欄位:</span>
                    <span class="review-value">${larkField}</span>
                </div>
                <div class="review-item">
                    <span class="review-label">範例值:</span>
                    <span class="review-value">${JSON.stringify(selectedFieldData.sample_value)}</span>
                </div>
            `;
            
            goToStep(6);
        }
        
        async function confirmAddField() {
            const finalPath = selectedFieldData.final_path || selectedFieldData.field_path;
            const categoryId = document.getElementById('fieldCategorySelect').value;
            const category = fieldCategories.find(c => c.id === categoryId);
            const larkField = document.getElementById('larkTargetFieldSelect').value;
            
            const mappingConfig = {
                jira_to_lark: {
                    [finalPath]: larkField
                }
            };
            
            // 如果需要添加處理規則
            if (category && category.id !== 'simple_fields') {
                mappingConfig.field_processing_rules = {};
                
                if (category.id === 'nested_fields' || category.id === 'user_fields' || 
                    category.id === 'datetime_fields') {
                    mappingConfig.field_processing_rules[category.id] = {
                        patterns: [finalPath],
                        processor: category.processor
                    };
                } else if (category.id.startsWith('array_')) {
                    mappingConfig.field_processing_rules.array_fields = {
                        [finalPath]: {
                            processor: category.processor
                        }
                    };
                }
            }
            
            try {
                showToast('正在新增欄位對應...', 'info', '精靈');
                
                const response = await apiCall('/api/config/field-mapping/add', 'POST', {
                    mapping_config: mappingConfig
                });
                
                if (response.status === 'success') {
                    showToast('欄位對應新增成功', 'success', '精靈');
                    
                    // 添加到 UI 清單（使用新格式）
                    const container = document.getElementById('fieldMappings');
                    const item = document.createElement('div');
                    item.className = 'mapping-item';
                    
                    // 根據選擇的類別確定 processor
                    const processor = category ? category.processor : 'extract_simple';
                    
                    item.innerHTML = `
                        <div class="mapping-row">
                            <input type="text" placeholder="JIRA 欄位" value="${finalPath}" class="jira-field">
                            <span class="mapping-arrow">→</span>
                            <input type="text" placeholder="Lark 欄位" value="${larkField}" class="lark-field">
                            <select class="processor-select">
                                <option value="extract_simple" ${processor === 'extract_simple' ? 'selected' : ''}>簡單提取</option>
                                <option value="extract_nested" ${processor === 'extract_nested' ? 'selected' : ''}>嵌套提取</option>
                                <option value="extract_user" ${processor === 'extract_user' ? 'selected' : ''}>用戶提取</option>
                                <option value="convert_datetime" ${processor === 'convert_datetime' ? 'selected' : ''}>日期轉換</option>
                                <option value="extract_components" ${processor === 'extract_components' ? 'selected' : ''}>組件提取</option>
                                <option value="extract_versions" ${processor === 'extract_versions' ? 'selected' : ''}>版本提取</option>
                                <option value="extract_links" ${processor === 'extract_links' ? 'selected' : ''}>連結提取</option>
                                <option value="extract_ticket_link" ${processor === 'extract_ticket_link' ? 'selected' : ''}>票據連結</option>
                            </select>
                            <button class="mapping-remove" onclick="removeMapping(this)">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                        <div class="mapping-options" style="display: ${processor === 'extract_nested' ? 'block' : 'none'}">
                            <input type="text" placeholder="嵌套路徑 (例如: name)" class="nested-path">
                        </div>
                        <div class="mapping-options" style="display: ${processor === 'extract_components' || processor === 'extract_versions' ? 'block' : 'none'}">
                            <select class="field-type-select">
                                <option value="">預設格式</option>
                                <option value="multiselect">多選欄位</option>
                            </select>
                        </div>
                    `;
                    container.appendChild(item);
                    
                    // Add event listener for processor changes
                    const processorSelect = item.querySelector('.processor-select');
                    const nestedOptions = item.querySelector('.mapping-options:nth-child(2)');
                    const typeOptions = item.querySelector('.mapping-options:nth-child(3)');
                    
                    processorSelect.addEventListener('change', function() {
                        const selectedProcessor = this.value;
                        if (nestedOptions) {
                            nestedOptions.style.display = selectedProcessor === 'extract_nested' ? 'block' : 'none';
                        }
                        if (typeOptions) {
                            typeOptions.style.display = (selectedProcessor === 'extract_components' || selectedProcessor === 'extract_versions') ? 'block' : 'none';
                        }
                    });
                    
                    // 關閉精靈
                    setTimeout(() => {
                        closeSmartFieldWizard();
                    }, 2000);
                } else {
                    showToast(response.message || '新增失敗', 'error', '精靈');
                }
            } catch (error) {
                console.error('新增欄位對應錯誤:', error);
                showToast('新增失敗', 'error', '精靈');
            }
        }
        
        function goToStep(step) {
            smartWizardStep = step;
            
            // 隱藏所有步驟
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`smartStep${i}`).style.display = i === step ? 'block' : 'none';
            }
            
            // 更新進度指示器
            document.querySelectorAll('.progress-step').forEach(stepEl => {
                const stepNum = parseInt(stepEl.dataset.step);
                stepEl.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    stepEl.classList.add('completed');
                } else if (stepNum === step) {
                    stepEl.classList.add('active');
                }
            });
        }

        // 啟動應用程式
        initializeApp();
    </script>
</body>
</html>