# JIRA-Lark 多團隊同步監控系統

## 功能特色

### ✨ 核心功能
- **並行同步**: 所有團隊表格同時獨立運行，互不影響
- **全畫面 TUI**: 直觀的文字終端介面
- **實時監控**: 即時顯示各表格同步狀態
- **配置熱重載**: 自動檢測 config.yaml 變更並套用
- **暫停/恢復**: 可隨時暫停或恢復特定表格的同步
- **每日清理提示**: 執行 table_scan_cleaner（含 data_cleaner）時在所有表格列顯示狀態，逾時 120 分鐘會強制終止並恢復同步
- **無閃動**: 使用 curses 優化，畫面流暢穩定

### 📊 介面布局

```
┌─────────────────────────────────────────────────────────────┐
│          JIRA-Lark 多團隊同步監控系統 (標題)                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  上方 1/3: 狀態區域                                           │
│  ─────────────────────────                                   │
│  ✓ ard.icr_table                                             │
│    上次:14:23:10 下次:14:28:10 (剩餘:285s)                    │
│    成功:42 失敗:0                                             │
│                                                              │
│  ⟳ ard.tcg_table [當前選中]                                   │
│    上次:14:22:05 下次:14:27:05 (剩餘:178s)                    │
│    成功:38 失敗:2                                             │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  下方 2/3: 日誌區域 (可左右切換表格，上下捲動)                 │
│  ─────────────────────────                                   │
│  日誌: ard.tcg_table (使用 ↑↓ 捲動)                           │
│                                                              │
│  [14:22:05] [INFO] 開始同步 ard.tcg_table                     │
│  [14:22:06] [INFO] 獲取 JIRA 數據...                          │
│  [14:22:08] [INFO] 處理 158 筆記錄                            │
│  [14:22:10] [INFO] 更新 Lark 表格...                          │
│  [14:22:12] [INFO] 同步成功 (第 38 次)                        │
│  [14:22:12] [INFO] 下次同步: 14:27:12                         │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  Q:退出 | ←→:切換表格 | P:暫停/恢復 | R:重新加載配置          │
└─────────────────────────────────────────────────────────────┘
```

## 🎮 操作說明

### 鍵盤快捷鍵

| 按鍵 | 功能 |
|------|------|
| `←` `→` | 切換表格 (左右箭頭) |
| `↑` `↓` | 捲動日誌 (上下箭頭) |
| `P` | 暫停/恢復當前選中的表格同步 |
| `R` | 手動重新加載配置檔案 |
| `Q` | 退出程式 |

### 狀態符號

| 符號 | 狀態 | 顏色 | 說明 |
|------|------|------|------|
| `⏸` | IDLE | 白色 | 待機中 |
| `⟳` | SYNCING | 黃色 | 同步中 |
| `✓` | SUCCESS | 綠色 | 成功 |
| `✗` | FAILED | 紅色 | 失敗 |
| `⏸` | PAUSED | 灰色 | 已暫停 |

### 狀態標記

| 標記 | 說明 |
|------|------|
| `[P]` | 手動暫停的表格 |
| `[C]` | 全域清理進行中（table_scan_cleaner） |

## 🚀 使用方式

### 方法 1: 使用啟動腳本 (推薦)

```bash
./start_sync_monitor.sh
```

### 方法 2: 直接執行 Python

```bash
python3 sync_monitor.py
```

### 背景運行

如果需要在背景運行並記錄日誌:

```bash
nohup ./start_sync_monitor.sh > sync_monitor.log 2>&1 &
```

## ⚙️ 配置說明

系統會自動讀取 `config.yaml` 中的設定:

### 啟用/停用團隊

```yaml
teams:
  ard:
    enabled: true      # 設為 false 停用整個團隊
    sync_interval: 300
```

### 啟用/停用表格

```yaml
teams:
  ard:
    tables:
      icr_table:
        enabled: true  # 設為 false 停用此表格
        sync_interval: 300
```

### 配置熱重載

系統會每 2 秒檢查一次 `config.yaml` 是否被修改:
- 檢測到變更後自動重新加載配置
- 新配置會在下一輪同步時生效
- 不會中斷當前正在進行的同步

## 🔧 技術特性

### 1. 並行同步架構

每個表格都運行在獨立的 asyncio 任務中，實現真正的並行處理:
- **真正並行**: 使用 `asyncio.create_subprocess_exec` 啟動獨立子進程
- **互不干擾**: 某個表格失敗不影響其他表格
- **獨立時間表**: 各自維護獨立的同步時間，支援不同的同步間隔
- **同時啟動**: 所有表格在程式啟動時同時開始第一次同步
- **高響應**: 0.1 秒檢查間隔，確保精確的同步時機

### 2. 父子關係和 Sprints 同步

對於所有 `tcg_table` 表格（無論哪個團隊）:
- 主同步完成後自動執行父子關係更新
- 自動更新 Sprints 欄位
- 使用 `parent_child_relationship_updater.py`

### 3. 畫面優化

使用 curses 庫實現:
- **雙緩衝**: 使用 `noutrefresh()` + `doupdate()` 防止閃動
- **智能刷新**: 只在必要時更新畫面 (0.1秒間隔)
- **顏色編碼**: 使用顏色對應不同狀態
- **動態布局**: 根據終端大小自動調整

### 4. 錯誤處理

完整的異常處理機制:
- 同步失敗不會崩潰整個系統
- 錯誤會記錄在表格的日誌中
- 失敗後會在下一個週期自動重試

## 📝 日誌系統

### 表格日誌

每個表格維護自己的日誌:
- **即時顯示**: 同步過程中逐行輸出，無需等待完成
- 最多保存 1000 條日誌
- 包含時間戳和日誌級別
- 可通過左右鍵切換查看
- 可通過上下鍵捲動歷史日誌

### 全局日誌

當沒有選中特定表格時顯示:
- 系統級別事件 (配置重載、任務重啟等)
- 最多保存 500 條日誌

### 日誌級別

- `[INFO]`: 一般資訊 (白色)
- `[WARNING]`: 警告 (黃色)
- `[ERROR]`: 錯誤 (紅色)

## 🎯 與原 sync_tables.sh 對比

| 功能 | sync_tables.sh | sync_monitor.py |
|------|----------------|-----------------|
| 並行同步 | ❌ 順序執行 | ✅ 真正並行 |
| TUI 介面 | ❌ 純文字輸出 | ✅ 全畫面 TUI |
| 實時狀態 | ❌ 僅日誌 | ✅ 狀態面板 |
| 表格切換 | ❌ 不支援 | ✅ 左右鍵切換 |
| 暫停/恢復 | ❌ 不支援 | ✅ 支援 |
| 配置熱重載 | ❌ 需重啟 | ✅ 自動檢測 |
| 畫面閃動 | N/A | ✅ 優化無閃動 |
| 日誌捲動 | ❌ 不支援 | ✅ 上下捲動 |

## 🔍 故障排除

### 問題: 畫面顯示異常

**解決方案**:
```bash
# 重置終端
reset

# 確保終端支援顏色
export TERM=xterm-256color

# 重新執行
./start_sync_monitor.sh
```

### 問題: 沒有顯示任何表格

**檢查項目**:
1. 確認 config.yaml 中至少有一個團隊和表格是 `enabled: true`
2. 檢查配置檔案格式是否正確 (YAML 語法)

**測試命令**:
```bash
python3 -c "import yaml; print(yaml.safe_load(open('config.yaml')))"
```

### 問題: 同步失敗

**檢查步驟**:
1. 使用左右鍵切換到失敗的表格
2. 查看錯誤日誌 (紅色的 ERROR 行)
3. 檢查 JIRA 和 Lark 的連接配置
4. 確認網路連接正常

### 問題: 父子關係更新失敗

**檢查項目**:
1. 確認 `parent_child_relationship_updater.py` 檔案存在
2. 確認 wiki_token 和 table_id 配置正確
3. 查看表格的錯誤日誌

## 📦 依賴需求

```bash
# Python 標準庫
- asyncio
- curses
- yaml (PyYAML)

# 安裝 PyYAML (如果尚未安裝)
pip3 install pyyaml
```

## 🛠️ 開發和調試

### 啟用詳細日誌

修改 config.yaml:
```yaml
global:
  log_level: DEBUG  # 詳細日誌
```

### 測試單一表格

可以暫停其他表格，只測試特定表格:
1. 啟動監控器
2. 使用左右鍵切換到目標表格
3. 按 `P` 暫停其他表格

### 查看日誌文件

主同步腳本的日誌會寫入:
```bash
tail -f jira_lark_sync.log
```

## 📄 授權

與主專案相同

## 🤝 貢獻

歡迎提交 Issue 和 Pull Request

---

**最後更新**: 2025-07-17
**版本**: 1.0.0
